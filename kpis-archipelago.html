<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Archipelago - Relatório Consolidado</title>
    
    <!-- API Script -->
    <script src="js/api.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 20px 20px;
        }

        /* =================== HEADER =================== */
        .page-header {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0;
            padding: 20px 30px;
            margin-bottom: 30px;
            border-left: 4px solid #60a5fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .page-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .hamburger {
            font-size: 28px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.3s;
            color: #60a5fa;
        }

        .hamburger:hover {
            background: rgba(96, 165, 250, 0.2);
        }

        .page-header h1 {
            color: #60a5fa;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .page-header .timestamp {
            color: #9ca3af;
            font-size: 14px;
            white-space: nowrap;
        }

        /* =================== BOTÕES DE AÇÃO =================== */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-print {
            background: #22c55e;
            color: white;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-reload {
            background: #3b82f6;
            color: white;
        }

        /* =================== LOADING =================== */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .loading-spinner {
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =================== MENU LATERAL =================== */
        .side-menu {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #1e293b;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }
        
        .side-menu.open {
            left: 0;
        }
        
        .menu-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h2 {
            margin: 0;
            color: #60a5fa;
            font-size: 20px;
        }
        
        .menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .menu-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .menu-items {
            padding: 20px 0;
        }
        
        .side-menu-item {
            display: block;
            padding: 12px 20px;
            color: #e2e8f0;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .side-menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #60a5fa;
        }
        
        .side-menu-item.active {
            background: rgba(96, 165, 250, 0.1);
            border-left-color: #60a5fa;
            color: #60a5fa;
            font-weight: 600;
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
        }
        
        .menu-overlay.active {
            display: block;
        }

        /* =================== ESTILOS DE IMPRESSÃO =================== */
        @media print {
            /* Ocultar elementos de navegação */
            .hamburger,
            .side-menu,
            .menu-overlay,
            .action-buttons,
            .btn,
            .btn-print,
            .btn-whatsapp,
            .btn-reload {
                display: none !important;
            }

            /* Resetar background e cores */
            body {
                background: white !important;
                color: black !important;
            }

            .page-container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            /* Header mais compacto */
            .page-header {
                background: white !important;
                border: none !important;
                padding: 5px 0 !important;
                margin-bottom: 8px !important;
                border-radius: 0 !important;
                page-break-after: avoid;
            }

            .page-header h1 {
                color: black !important;
                font-size: 16px !important;
                margin: 0 !important;
                font-weight: 700 !important;
            }

            .page-header-left {
                gap: 8px !important;
            }

            .timestamp {
                color: #666 !important;
                font-size: 9px !important;
            }

            /* DASHBOARD EXECUTIVO: 1 página */
            .dashboard-section.executivo {
                page-break-after: always !important;
                page-break-inside: avoid;
                background: white !important;
                border: 1px solid #ccc !important;
                border-left: 2px solid #666 !important;
                padding: 12px !important;
                margin-bottom: 0 !important;
            }

            /* CADA HOSPITAL: 1 página */
            .dashboard-section.hospitalar {
                page-break-before: always !important;
                page-break-after: always !important;
                page-break-inside: avoid;
                background: white !important;
                border: 1px solid #ccc !important;
                border-left: 2px solid #666 !important;
                padding: 12px !important;
                margin-bottom: 0 !important;
            }

            /* Último hospital: não quebrar página depois */
            .dashboard-section.hospitalar:last-child {
                page-break-after: auto !important;
            }

            /* Header das seções */
            .dashboard-header-section {
                margin-bottom: 10px !important;
                padding-bottom: 6px !important;
                border-bottom: 1px solid #ccc !important;
            }

            .dashboard-header-section h2 {
                color: black !important;
                font-size: 14px !important;
                margin: 0 !important;
                font-weight: 700 !important;
            }

            .badge {
                font-size: 8px !important;
                padding: 2px 6px !important;
                background: #f5f5f5 !important;
                color: #666 !important;
                border: 1px solid #ccc !important;
            }

            /* KPI Grid - 3 colunas balanceadas */
            .kpis-grid {
                gap: 8px !important;
                grid-template-columns: repeat(3, 1fr) !important;
            }

            /* KPI Boxes - tamanho fixo e balanceado */
            .kpi-box {
                background: white !important;
                border: 1px solid #ccc !important;
                padding: 10px !important;
                min-height: 160px !important;
                max-height: 160px !important;
                page-break-inside: avoid;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .kpi-title {
                color: black !important;
                font-size: 10px !important;
                margin-bottom: 6px !important;
                font-weight: 700 !important;
                text-transform: uppercase;
                border-bottom: 1px solid #eee;
                padding-bottom: 4px;
            }

            /* Valores dos KPIs - proporcionais */
            .kpi-valor-unico {
                text-align: center;
                padding: 8px 0;
            }

            .kpi-valor-unico .valor {
                font-size: 32px !important;
                color: black !important;
                font-weight: 700;
                line-height: 1;
            }

            .kpi-valor-unico .label {
                font-size: 9px !important;
                color: #666 !important;
                margin-top: 4px;
            }

            .kpi-valores-duplos-divididos {
                display: flex;
                gap: 8px !important;
                align-items: center;
                padding: 8px 0;
            }

            .kpi-valor-metade {
                flex: 1;
                text-align: center;
            }

            .kpi-valor-metade .valor {
                font-size: 24px !important;
                color: black !important;
                font-weight: 700;
                line-height: 1;
            }

            .kpi-valor-metade .label {
                font-size: 8px !important;
                color: #666 !important;
                margin-top: 3px;
            }

            .divisor-vertical {
                width: 1px;
                height: 40px;
                background: #ddd !important;
            }

            /* Gauge - tamanho reduzido */
            .gauge-container {
                margin: 6px auto !important;
                text-align: center;
            }

            .gauge-container svg {
                width: 100px !important;
                height: 60px !important;
                filter: grayscale(80%) !important;
            }

            /* Capacidade e Modalidade - mais compactas */
            .kpi-capacidade,
            .kpi-modalidade {
                flex: 1;
                overflow: hidden;
            }

            .kpi-capacidade-item,
            .kpi-modalidade-item {
                font-size: 8px !important;
                padding: 4px 6px !important;
                display: flex;
                justify-content: space-between;
                border-bottom: 1px solid #f5f5f5;
            }

            .kpi-capacidade-item:last-child,
            .kpi-modalidade-item:last-child {
                border-bottom: none;
            }

            .kpi-capacidade-item .tipo,
            .kpi-modalidade-item .tipo {
                color: #666 !important;
                font-size: 8px;
            }

            .kpi-capacidade-item .valor,
            .kpi-modalidade-item .valor {
                color: black !important;
                font-weight: 700 !important;
                font-size: 8px;
            }

            /* Detalhes (tabelas) - compactas */
            .kpi-detalhes {
                margin-top: 6px !important;
                padding-top: 6px !important;
                border-top: 1px solid #eee !important;
                flex: 1;
                overflow: hidden;
            }

            .detalhe-titulo {
                font-size: 8px !important;
                color: #666 !important;
                margin-bottom: 4px !important;
                font-weight: 600;
            }

            .hospitais-table {
                font-size: 7px !important;
                width: 100%;
                border-collapse: collapse;
            }

            .hospitais-table th {
                background: #f5f5f5 !important;
                color: black !important;
                padding: 3px !important;
                font-weight: 700 !important;
                border: 1px solid #ddd !important;
                font-size: 7px;
            }

            .hospitais-table td {
                padding: 3px !important;
                border: 1px solid #eee !important;
                color: black !important;
                font-size: 7px;
            }

            .sem-dados {
                font-size: 8px !important;
                color: #999 !important;
                text-align: center;
                padding: 6px;
            }

            /* Box de Taxa de Ocupação - especial */
            .box-taxa-ocupacao {
                grid-column: 1 / 2;
            }

            /* Box TPH, PPS, SPICT - altura consistente */
            .box-tph,
            .box-pps,
            .box-spict {
                border-left: 2px solid #ddd !important;
            }

            /* Tabelas dentro dos boxes - scrollable */
            .kpi-detalhes {
                max-height: 80px;
                overflow: hidden;
            }

            /* Remover loading */
            #loading {
                display: none !important;
            }

            /* Forçar exibição do conteúdo */
            #content {
                display: block !important;
            }

            /* Ajustar margens da página */
            @page {
                margin: 1cm;
                size: A4 portrait;
            }

            /* Título do Box de Leitos Disponíveis */
            .box-disponiveis .kpi-title {
                font-size: 9px !important;
            }

            /* Subtítulo capacidade */
            .kpi-capacidade h4,
            .kpi-modalidade h4 {
                font-size: 8px !important;
                color: #666 !important;
                margin: 0 0 4px 0 !important;
                font-weight: 600 !important;
            }

            /* Lista de Hospitais na tabela */
            .hospitais-table tbody tr:nth-child(even) {
                background: #fafafa !important;
            }

            /* Otimizar impressão colorida */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* =================== DASHBOARD SECTION =================== */
        .dashboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            page-break-inside: avoid;
        }

        .dashboard-section.executivo {
            border-left: 4px solid #8b5cf6;
        }

        .dashboard-section.hospitalar {
            border-left: 4px solid #60a5fa;
        }

        .dashboard-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-header-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
        }

        .dashboard-header-section .badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.executivo {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid #8b5cf6;
        }

        .badge.hospital {
            background: rgba(96, 165, 250, 0.2);
            color: #93c5fd;
            border: 1px solid #60a5fa;
        }

        /* =================== KPI GRID (3 COLUNAS) =================== */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kpis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* =================== KPI BOX =================== */
        .kpi-box {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .kpi-box:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Cores da borda superior */
        .box-ocupados { border-top: 3px solid #22c55e; }
        .box-previsao { border-top: 3px solid #f97316; }
        .box-disponiveis { border-top: 3px solid #3b82f6; }
        .box-tph { border-top: 3px solid #8b5cf6; }
        .box-pps { border-top: 3px solid #ec4899; }
        .box-spict { border-top: 3px solid #14b8a6; }
        .box-ocupacao-geral { border-top: 3px solid #22c55e; }

        /* Título do Box */
        .kpi-title {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            text-align: center; /* ✅ CENTRALIZADO */
        }

        /* =================== GAUGE MEIA-ROSCA (NORMAL) =================== */
        .v5-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
        }

        .v5-gauge {
            width: 120px;
            height: 70px;
        }

        .v5-number-inside {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 43px; /* ✅ REDUZIDO 10% (era 48px) */
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-top: 8px;
        }

        .v5-badge-below {
            font-size: 14px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid;
        }

        .v5-badge-below.green {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: #22c55e;
        }

        .v5-badge-below.orange {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border-color: #f97316;
        }

        .v5-badge-below.blue {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        /* =================== GAUGE LARGO (EXECUTIVO - MAIOR) =================== */
        .gauge-largo-container {
            position: relative;
            width: 500px; /* ✅ AUMENTADO (era 450px) */
            height: 280px; /* ✅ AUMENTADO para não cortar (era 250px) */
            margin: 0 auto;
            padding-top: 20px; /* ✅ PADDING para não cortar o topo */
        }

        .gauge-largo-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%);
            text-align: center;
            width: 100%;
        }

        .gauge-largo-number {
            font-size: 72px; /* ✅ NÚMERO EM CIMA - MAIOR */
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-bottom: 8px;
        }

        .gauge-largo-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .gauge-largo-percentage {
            font-size: 60px; /* ✅ AUMENTADO 25% (era 48px) */
            font-weight: 700;
            color: #22c55e;
            padding: 6px 16px;
            border-radius: 12px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            display: inline-block;
            margin-top: 8px;
        }

        .gauge-largo-subtitle {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.4;
            margin-top: 8px;
        }

        /* =================== CONTEÚDO DO BOX (NOVO LAYOUT) =================== */
        .kpi-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex: 1;
        }

        /* Lista de Tipos (ABAIXO DO GAUGE) */
        .kpi-items-lista {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .item-lista {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s ease;
        }

        .item-lista:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .item-lista .label {
            font-size: 14px;
            color: #9ca3af;
        }

        .item-lista .valor {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        /* Texto acima da lista (para Disponíveis) */
        .kpi-subtitle {
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
            text-align: center;
            margin-bottom: 10px;
        }

        /* =================== DETALHES (5 CATEGORIAS MODALIDADE) =================== */
        .kpi-detalhes {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .detalhe-titulo {
            font-size: 11px;
            font-weight: 600;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        /* Lista Compacta (50% espaçamento) */
        .lista-simples-compacta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lista-item-compacto {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s ease;
        }

        .lista-item-compacto:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lista-item-compacto .label {
            font-size: 13px;
            color: #9ca3af;
        }

        .lista-item-compacto .valor {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
        }

        /* =================== VALORES DUPLOS (PPS / SPICT) =================== */
        .kpi-valores-duplos-divididos {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 20px;
        }

        .kpi-valor-metade {
            flex: 1;
            text-align: center;
        }

        .kpi-valor-metade .valor {
            font-size: 72px;
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-bottom: 8px;
        }

        .kpi-valor-metade .label {
            font-size: 13px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .divisor-vertical {
            width: 1px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* =================== TPH =================== */
        .kpi-tph-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .kpi-tph-numero {
            font-size: 80px;
            font-weight: 700;
            color: white;
            line-height: 1;
        }

        .kpi-tph-label {
            font-size: 16px;
            color: #9ca3af;
            margin-top: 8px;
        }

        /* =================== TPH MINI GAUGE =================== */
        .tph-mini-gauge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .tph-gauge-bar {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }

        .tph-gauge-block {
            width: 8px;
            height: 20px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .tph-gauge-block.filled {
            background: currentColor;
        }

        .tph-gauge-block.empty {
            background: rgba(255, 255, 255, 0.1);
        }

        .tph-gauge-label {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
        }

        .tph-gauge-bar.green { color: #22c55e; }
        .tph-gauge-bar.yellow { color: #f59e0b; }
        .tph-gauge-bar.red { color: #ef4444; }

        /* =================== TABELAS =================== */
        .hospitais-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .hospitais-table thead {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hospitais-table th {
            text-align: left;
            padding: 8px;
            color: #60a5fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .hospitais-table td {
            padding: 8px;
            color: #e5e7eb;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .hospitais-table tbody tr:last-child td {
            border-bottom: none;
        }

        .hospitais-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .sem-dados {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-style: italic;
            font-size: 13px;
        }

        /* =================== BOX OCUPAÇÃO GERAL (EXECUTIVO) =================== */
        .box-ocupacao-geral .kpi-content {
            flex-direction: column;
            align-items: center;
        }

        /* =================== PRINT =================== */
        @media print {
            body {
                background: white;
                color: black;
                padding: 0;
            }

            .action-buttons {
                display: none;
            }

            .dashboard-section {
                page-break-inside: avoid;
                border: 1px solid #ddd;
            }

            .kpi-box {
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- MENU LATERAL -->
        <aside id="sideMenu" class="side-menu">
            <div class="menu-header">
                <h2>Menu</h2>
                <button class="menu-close" onclick="toggleMenu()">×</button>
            </div>
            
            <nav class="menu-items">
                <a href="index.html" class="side-menu-item">
                    Leitos
                </a>
                <a href="index.html#dash1" class="side-menu-item">
                    Dashboard Hospitalar
                </a>
                <a href="index.html#dash2" class="side-menu-item">
                    Dashboard Executivo
                </a>
                <a href="#" class="side-menu-item active" onclick="closeMenu(); return false;">
                    KPIs
                </a>
            </nav>
        </aside>

        <!-- OVERLAY DO MENU -->
        <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

        <!-- HEADER -->
        <div class="page-header">
            <div class="page-header-left">
                <span class="hamburger" onclick="toggleMenu()">☰</span>
                <h1>KPIs Archipelago</h1>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="timestamp" id="timestamp">Carregando...</div>
                <div class="action-buttons">
                    <button class="btn btn-print" onclick="window.print()">
                        Imprimir
                    </button>
                    <button class="btn btn-whatsapp" onclick="copiarParaWhatsApp()">
                        Copiar para WhatsApp
                    </button>
                    <button class="btn btn-reload" onclick="recarregarDados()">
                        Atualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Carregando dados da planilha...</p>
        </div>

        <!-- CONTENT -->
        <div id="content" style="display: none;">
            <!-- DASHBOARD EXECUTIVO -->
            <div id="kpi-executivo"></div>

            <!-- DASHBOARDS HOSPITALARES -->
            <div id="kpis-hospitalares"></div>
        </div>
    </div>

    <script>
        // =================== FUNÇÕES AUXILIARES DE STATUS ===================
        
        // ✅ CORREÇÃO: Verificar se leito está ocupado (case-insensitive + "Em uso")
        function isOcupado(leito) {
            if (!leito || !leito.status) return false;
            const status = leito.status.toLowerCase();
            return status === 'ocupado' || status === 'em uso';
        }
        
        // ✅ CORREÇÃO: Verificar se leito está vago (case-insensitive)
        function isVago(leito) {
            if (!leito || !leito.status) return false;
            return leito.status.toLowerCase() === 'vago';
        }
        
        // =================== FUNÇÕES AUXILIARES ===================
        
        function formatarData() {
            const agora = new Date();
            const opcoes = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return agora.toLocaleDateString('pt-BR', opcoes);
        }

        function calcularGaugeOffset(porcentagem) {
            const circunferencia = Math.PI * 55; // Meia rosca
            const progresso = (porcentagem / 100) * circunferencia;
            return circunferencia - progresso;
        }

        function calcularGaugeLargoOffset(porcentagem) {
            const circunferencia = Math.PI * 200; // ✅ Gauge largo MAIOR
            const progresso = (porcentagem / 100) * circunferencia;
            return circunferencia - progresso;
        }

        // =================== RENDER GAUGE V5 (MEIA ROSCA - NORMAL) ===================
        
        function renderGaugeV5(porcentagem, cor, numero) {
            const offset = calcularGaugeOffset(porcentagem);
            const badgeClass = cor === '#22c55e' ? 'green' : (cor === '#f97316' ? 'orange' : 'blue');
            
            return `
                <div class="v5-gauge-container">
                    <div style="position: relative;">
                        <svg class="v5-gauge" viewBox="0 0 140 80">
                            <!-- Fundo cinza -->
                            <path d="M 15 70 A 55 55 0 0 1 125 70" 
                                  fill="none" 
                                  stroke="rgba(255,255,255,0.1)" 
                                  stroke-width="14" 
                                  stroke-linecap="round"/>
                            <!-- Progresso -->
                            <path d="M 15 70 A 55 55 0 0 1 125 70" 
                                  fill="none" 
                                  stroke="${cor}" 
                                  stroke-width="14" 
                                  stroke-linecap="round"
                                  stroke-dasharray="172.8"
                                  stroke-dashoffset="${offset}"/>
                        </svg>
                        <div class="v5-number-inside">${numero.toString().padStart(2, '0')}</div>
                    </div>
                    <div class="v5-badge-below ${badgeClass}">${porcentagem.toFixed(0)}%</div>
                </div>
            `;
        }

        // =================== RENDER GAUGE LARGO (EXECUTIVO - MAIOR) ===================
        
        function renderMiniGaugeTPH(dias) {
            const maxDias = 30;
            const porcentagem = (dias / maxDias) * 100;
            
            // Determinar cor baseado na porcentagem
            let corClass = 'green';
            if (porcentagem >= 67) corClass = 'red';
            else if (porcentagem >= 47) corClass = 'yellow';
            
            // Criar 20 blocos
            const totalBlocos = 20;
            const blocosCheios = Math.round((dias / maxDias) * totalBlocos);
            
            let blocos = '';
            for (let i = 0; i < totalBlocos; i++) {
                blocos += `<div class="tph-gauge-block ${i < blocosCheios ? 'filled' : 'empty'}"></div>`;
            }
            
            return `
                <div class="tph-mini-gauge">
                    <div class="tph-gauge-bar ${corClass}">
                        ${blocos}
                    </div>
                    <span class="tph-gauge-label">${dias}/${maxDias}</span>
                </div>
            `;
        }
        
        function renderGaugeLargo(porcentagem, numeroTotal) {
            const offset = calcularGaugeLargoOffset(porcentagem);
            
            return `
                <div style="display: flex; justify-content: center; margin: 20px 0 30px 0;">
                    <div class="gauge-largo-container">
                        <!-- SVG Gauge Largo -->
                        <svg viewBox="0 0 500 280" style="width: 100%; height: 100%;">
                            <!-- Fundo cinza -->
                            <path d="M 50 220 A 200 200 0 0 1 450 220" 
                                  fill="none" 
                                  stroke="rgba(255,255,255,0.1)" 
                                  stroke-width="30" 
                                  stroke-linecap="round"/>
                            <!-- Progresso verde -->
                            <path d="M 50 220 A 200 200 0 0 1 450 220" 
                                  fill="none" 
                                  stroke="#22c55e" 
                                  stroke-width="30" 
                                  stroke-linecap="round"
                                  stroke-dasharray="628.3"
                                  stroke-dashoffset="${offset}"/>
                        </svg>
                        
                        <!-- Informações dentro do gauge -->
                        <div class="gauge-largo-info">
                            <div class="gauge-largo-number">${numeroTotal}</div>
                            <div class="gauge-largo-label">LEITOS OCUPADOS</div>
                            <div class="gauge-largo-percentage">${porcentagem.toFixed(0)}%</div>
                            <div class="gauge-largo-subtitle">
                                Total da Rede Externa<br/>(5 Hospitais)
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== RENDER MODALIDADE CONTRATUAL ===================
        
        function renderModalidadeContratual(modalidade) {
            return `
                <div class="lista-simples-compacta">
                    <div class="lista-item-compacto">
                        <span class="label">Flexíveis quanto ao plano</span>
                        <span class="valor">${modalidade.flexiveis || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclusivamente Apartamentos</span>
                        <span class="valor">${modalidade.exclusivo_apto || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf sem Restrição</span>
                        <span class="valor">${modalidade.exclusivo_enf_sem_restricao || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf Feminina</span>
                        <span class="valor">${modalidade.exclusivo_enf_fem || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf Masculina</span>
                        <span class="valor">${modalidade.exclusivo_enf_masc || 0}</span>
                    </div>
                </div>
            `;
        }

        // =================== NOVA FUNÇÃO: CALCULAR MODALIDADES POR HOSPITAL ===================
        
        function calcularModalidadesVagos(leitos, hospitalId) {
            const modalidade = {
                flexiveis: 0,
                exclusivo_apto: 0,
                exclusivo_enf_sem_restricao: 0,
                exclusivo_enf_fem: 0,
                exclusivo_enf_masc: 0
            };

            const vagos = leitos.filter(l => isVago(l));

            // ====== REGRA 1: H1, H3, H5 (HÍBRIDOS PUROS) ======
            if (hospitalId === 'H1' || hospitalId === 'H3' || hospitalId === 'H5') {
                modalidade.flexiveis = vagos.length;
                return modalidade;
            }

            // ====== REGRA 2: H4 - SANTA CLARA (HÍBRIDO COM LIMITES) ======
            if (hospitalId === 'H4') {
                const ocupados = leitos.filter(l => isOcupado(l));
                
                const aptosOcupados = ocupados.filter(l => 
                    l.categoriaEscolhida === 'Apartamento'
                ).length;
                
                const enfOcupadas = ocupados.filter(l => 
                    l.categoriaEscolhida === 'Enfermaria'
                ).length;
                
                modalidade.flexiveis = 0;
                modalidade.exclusivo_apto = 9 - aptosOcupados;
                modalidade.exclusivo_enf_sem_restricao = 4 - enfOcupadas;
                modalidade.exclusivo_enf_fem = 0;
                modalidade.exclusivo_enf_masc = 0;
                
                return modalidade;
            }

            // ====== REGRA 3: H2 - CRUZ AZUL (TIPOS FIXOS + LEITO IRMÃO) ======
            if (hospitalId === 'H2') {
                vagos.forEach(leitoVago => {
                    const tipo = leitoVago.tipo || '';
                    
                    // APTOs vagos → Exclusivamente Apartamentos
                    if (tipo === 'APTO' || tipo === 'Apartamento') {
                        modalidade.exclusivo_apto++;
                        return;
                    }
                    
                    // ENFERMARIAs → Sistema de Leito Irmão
                    if (tipo === 'ENFERMARIA' || tipo === 'Enfermaria') {
                        const numeroLeito = leitoVago.leito;
                        
                        if (!numeroLeito || typeof numeroLeito !== 'number') {
                            // Sem número de leito → Sem restrição
                            modalidade.exclusivo_enf_sem_restricao++;
                            return;
                        }
                        
                        // ✅ LÓGICA CORRIGIDA: Leitos irmãos são números consecutivos
                        // Ímpares (21, 23, 25...) → irmão é +1
                        // Pares (22, 24, 26...) → irmão é -1
                        const numeroIrmao = (numeroLeito % 2 === 0) 
                            ? numeroLeito - 1  // Par → irmão é o anterior
                            : numeroLeito + 1; // Ímpar → irmão é o próximo
                        
                        // Buscar irmão pelo campo 'leito'
                        const irmao = leitos.find(l => l.leito === numeroIrmao);
                        
                        if (!irmao || isVago(irmao)) {
                            // Ambos vagos OU irmão não encontrado → Sem restrição
                            modalidade.exclusivo_enf_sem_restricao++;
                        } else if (irmao.isolamento && irmao.isolamento !== 'Não Isolamento') {
                            // Irmão com isolamento → BLOQUEADO (não conta)
                            // Não incrementa nada
                        } else {
                            // Irmão ocupado → Verificar gênero do paciente no irmão
                            if (irmao.genero === 'Feminino') {
                                modalidade.exclusivo_enf_fem++;
                            } else if (irmao.genero === 'Masculino') {
                                modalidade.exclusivo_enf_masc++;
                            } else {
                                // Sem gênero definido → Sem restrição
                                modalidade.exclusivo_enf_sem_restricao++;
                            }
                        }
                    }
                });
                
                return modalidade;
            }

            // Fallback (não deveria chegar aqui)
            return modalidade;
        }

        function calcularModalidadePorTipo(leitos, hospitalId) {
            const modalidade = {
                flexiveis: 0,
                exclusivo_apto: 0,
                exclusivo_enf_sem_restricao: 0,
                exclusivo_enf_fem: 0,
                exclusivo_enf_masc: 0
            };

            // ✅ HOSPITAIS HÍBRIDOS PUROS (H1, H3, H5): TUDO EM FLEXÍVEIS
            // H4 é híbrido mas com limitações, então não entra aqui
            if (hospitalId === 'H1' || hospitalId === 'H3' || hospitalId === 'H5') {
                modalidade.flexiveis = leitos.length;
                return modalidade;
            }

            // Para OCUPADOS e EM PREVISÃO: classificar por categoria escolhida
            leitos.forEach(leito => {
                const catEscolhida = leito.categoriaEscolhida || leito.categoria || '';
                const genero = leito.genero || '';
                
                if (catEscolhida === 'Apartamento') {
                    modalidade.exclusivo_apto++;
                } else if (catEscolhida === 'Enfermaria') {
                    // Enfermarias sempre sem restrição quando ocupadas (exceto H2)
                    if (hospitalId === 'H2') {
                        if (genero === 'Feminino') {
                            modalidade.exclusivo_enf_fem++;
                        } else if (genero === 'Masculino') {
                            modalidade.exclusivo_enf_masc++;
                        } else {
                            modalidade.exclusivo_enf_sem_restricao++;
                        }
                    } else {
                        modalidade.exclusivo_enf_sem_restricao++;
                    }
                } else {
                    // Híbrido ou indefinido
                    modalidade.flexiveis++;
                }
            });

            return modalidade;
        }

        // =================== PROCESSAR DADOS DA PLANILHA ===================
        
        function processarDadosHospital(hospitalId) {
            const hospitalObj = window.hospitalData[hospitalId] || {};
            
            console.log(`Processando ${hospitalId}:`, hospitalObj);
            
            let leitos = hospitalObj.leitos || hospitalObj || [];
            if (!Array.isArray(leitos)) {
                console.warn(`${hospitalId}: leitos não é array, convertendo...`);
                leitos = [];
            }
            
            console.log(`${hospitalId}: ${leitos.length} leitos encontrados`);
            
            // Calcular ocupados
            const ocupados = leitos.filter(l => isOcupado(l));
            
            // ✅ Para hospitais HÍBRIDOS: usar categoria_escolhida
            let ocupadosApto, ocupadosEnfFem, ocupadosEnfMasc;
            
            if (hospitalId === 'H1' || hospitalId === 'H3' || hospitalId === 'H4' || hospitalId === 'H5') {
                // Híbridos: baseado em categoria_escolhida + gênero
                ocupadosApto = ocupados.filter(l => 
                    l.categoriaEscolhida === 'Apartamento'
                ).length;
                ocupadosEnfFem = ocupados.filter(l => 
                    l.categoriaEscolhida === 'Enfermaria' && l.genero === 'Feminino'
                ).length;
                ocupadosEnfMasc = ocupados.filter(l => 
                    l.categoriaEscolhida === 'Enfermaria' && l.genero === 'Masculino'
                ).length;
            } else {
                // H2 - CRUZ AZUL: baseado em tipo + gênero do paciente
                ocupadosApto = ocupados.filter(l => 
                    l.tipo === 'Apartamento' || l.tipo === 'APTO'
                ).length;
                ocupadosEnfFem = ocupados.filter(l => 
                    (l.tipo === 'ENFERMARIA' || l.tipo === 'Enfermaria') && l.genero === 'Feminino'
                ).length;
                ocupadosEnfMasc = ocupados.filter(l => 
                    (l.tipo === 'ENFERMARIA' || l.tipo === 'Enfermaria') && l.genero === 'Masculino'
                ).length;
            }
            
            // Calcular previsão de alta
            const previsaoAlta = leitos.filter(l => l.prevAlta && l.prevAlta.trim() !== '');
            
            // ✅ Para hospitais HÍBRIDOS: usar categoria_escolhida
            let previsaoApto, previsaoEnfFem, previsaoEnfMasc;
            
            if (hospitalId === 'H1' || hospitalId === 'H3' || hospitalId === 'H4' || hospitalId === 'H5') {
                // Híbridos: baseado em categoria_escolhida + gênero
                previsaoApto = previsaoAlta.filter(l => 
                    l.categoriaEscolhida === 'Apartamento'
                ).length;
                previsaoEnfFem = previsaoAlta.filter(l => 
                    l.categoriaEscolhida === 'Enfermaria' && l.genero === 'Feminino'
                ).length;
                previsaoEnfMasc = previsaoAlta.filter(l => 
                    l.categoriaEscolhida === 'Enfermaria' && l.genero === 'Masculino'
                ).length;
            } else {
                // H2 - CRUZ AZUL: baseado em tipo + gênero do paciente
                previsaoApto = previsaoAlta.filter(l => 
                    l.tipo === 'Apartamento' || l.tipo === 'APTO'
                ).length;
                previsaoEnfFem = previsaoAlta.filter(l => 
                    (l.tipo === 'ENFERMARIA' || l.tipo === 'Enfermaria') && l.genero === 'Feminino'
                ).length;
                previsaoEnfMasc = previsaoAlta.filter(l => 
                    (l.tipo === 'ENFERMARIA' || l.tipo === 'Enfermaria') && l.genero === 'Masculino'
                ).length;
            }
            
            // Calcular disponíveis
            const vagos = leitos.filter(l => isVago(l));
            
            // ✅ H2 tem lógica diferente para vagos
            let vagosApto, vagosEnfFem, vagosEnfMasc;
            
            if (hospitalId === 'H2') {
                // H2: Dividir enfermarias por gênero baseado no leito irmão ocupado
                vagosApto = vagos.filter(l => 
                    l.tipo === 'Apartamento' || l.tipo === 'APTO'
                ).length;
                
                // Contar enfermarias por gênero do irmão ocupado
                vagosEnfFem = 0;
                vagosEnfMasc = 0;
                let vagosEnfSemRestricao = 0;
                
                vagos.forEach(leitoVago => {
                    const tipo = leitoVago.tipo || '';
                    
                    if (tipo === 'ENFERMARIA' || tipo === 'Enfermaria') {
                        const numeroLeito = leitoVago.leito;
                        
                        if (!numeroLeito || typeof numeroLeito !== 'number') {
                            vagosEnfSemRestricao++;
                            return;
                        }
                        
                        // ✅ LÓGICA CORRIGIDA: Leitos irmãos são números consecutivos
                        // Ímpares (21, 23, 25...) → irmão é +1
                        // Pares (22, 24, 26...) → irmão é -1
                        const numeroIrmao = (numeroLeito % 2 === 0) 
                            ? numeroLeito - 1  // Par → irmão é o anterior
                            : numeroLeito + 1; // Ímpar → irmão é o próximo
                        
                        // Buscar irmão pelo campo 'leito'
                        const irmao = leitos.find(l => l.leito === numeroIrmao);
                        
                        if (!irmao || isVago(irmao)) {
                            // Ambos vagos OU irmão não encontrado → Sem restrição
                            vagosEnfSemRestricao++;
                        } else if (irmao.isolamento && irmao.isolamento !== 'Não Isolamento') {
                            // Irmão com isolamento → BLOQUEADO (não conta)
                        } else {
                            // Irmão ocupado → Dividir por gênero do paciente no irmão
                            if (irmao.genero === 'Feminino') {
                                vagosEnfFem++;
                            } else if (irmao.genero === 'Masculino') {
                                vagosEnfMasc++;
                            } else {
                                vagosEnfSemRestricao++;
                            }
                        }
                    }
                });
                
                // DEBUG H2
                console.log('[H2 VAGOS DEBUG]', {
                    vagosApto,
                    vagosEnfFem,
                    vagosEnfMasc,
                    vagosEnfSemRestricao,
                    totalVagos: vagos.length
                });
            } else {
                // Outros hospitais
                vagosApto = vagos.filter(l => 
                    l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'Híbrido'
                ).length;
                vagosEnfFem = vagos.filter(l => 
                    l.tipo === 'Enfermaria Feminina'
                ).length;
                vagosEnfMasc = vagos.filter(l => 
                    l.tipo === 'Enfermaria Masculina'
                ).length;
            }

            // ✅ HOSPITAIS HÍBRIDOS: Disponíveis podem ser QUALQUER tipo
            let vagosAptoFinal = vagosApto;
            let vagosEnfFemFinal = vagosEnfFem;
            let vagosEnfMascFinal = vagosEnfMasc;
            
            if (hospitalId === 'H1' || hospitalId === 'H3' || hospitalId === 'H5') {
                // Para híbridos: TODOS os vagos podem ser usados como qualquer tipo
                vagosAptoFinal = vagos.length;
                vagosEnfFemFinal = vagos.length;
                vagosEnfMascFinal = vagos.length;
            }
            
            // TPH médio
            const tphValues = ocupados
                .map(l => {
                    if (!l.admAt) return 0;
                    const admData = new Date(l.admAt);
                    const hoje = new Date();
                    const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                    return dias > 0 ? dias : 0;
                })
                .filter(v => v > 0);
            const tphMedio = tphValues.length > 0 
                ? (tphValues.reduce((a, b) => a + b, 0) / tphValues.length).toFixed(1)
                : 0;
            
            const leitosMais5Diarias = ocupados.filter(l => {
                if (!l.admAt) return false;
                const admData = new Date(l.admAt);
                const hoje = new Date();
                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                return dias > 5;
            }).map(l => {
                const admData = new Date(l.admAt);
                const hoje = new Date();
                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                return { ...l, dias };
            });
            
            // PPS
            const ppsValues = ocupados
                .map(l => parseInt(l.pps) || 0)
                .filter(v => v > 0);
            const ppsMedio = ppsValues.length > 0
                ? Math.round(ppsValues.reduce((a, b) => a + b, 0) / ppsValues.length)
                : 0;
            const ppsMenor40 = ocupados.filter(l => parseInt(l.pps) < 40);
            
            // SPICT
            const spictElegiveis = ocupados.filter(l => 
                l.spict && l.spict.toLowerCase() === 'elegivel'
            );
            const diretivasPendentes = ocupados.filter(l => 
                l.spict && l.spict.toLowerCase() === 'elegivel' && (!l.diretivas || l.diretivas.trim() === '' || l.diretivas === 'Não')
            );
            
            // Calcular taxa de ocupação
            const totalLeitos = leitos.length;
            const taxaOcupacao = totalLeitos > 0 ? (ocupados.length / totalLeitos * 100) : 0;
            
            // USAR NOVA FUNÇÃO DE CÁLCULO DE MODALIDADES
            const modalidadeOcupados = calcularModalidadePorTipo(ocupados, hospitalId);
            const modalidadePrevisao = calcularModalidadePorTipo(previsaoAlta, hospitalId);
            const modalidadeDisponiveis = calcularModalidadesVagos(leitos, hospitalId); // ✅ NOVA FUNÇÃO PARA VAGOS!
            
            return {
                nome: hospitalId === 'H1' ? 'NEOMATER' :
                      hospitalId === 'H2' ? 'CRUZ AZUL' :
                      hospitalId === 'H3' ? 'STA MARCELINA' :
                      hospitalId === 'H4' ? 'SANTA CLARA' :
                      'ADVENTISTA',
                totalLeitos,
                taxaOcupacao,
                ocupados: {
                    total: ocupados.length,
                    apartamento: ocupadosApto,
                    enf_feminina: ocupadosEnfFem,
                    enf_masculina: ocupadosEnfMasc,
                    modalidade: modalidadeOcupados
                },
                previsao: {
                    total: previsaoAlta.length,
                    apartamento: previsaoApto,
                    enf_feminina: previsaoEnfFem,
                    enf_masculina: previsaoEnfMasc,
                    modalidade: modalidadePrevisao
                },
                disponiveis: {
                    total: vagos.length,
                    apartamento: vagosAptoFinal,
                    enf_feminina: vagosEnfFemFinal,
                    enf_masculina: vagosEnfMascFinal,
                    modalidade: modalidadeDisponiveis
                },
                // DEBUG
                ...(hospitalId === 'H2' && console.log('[H2 RETURN DEBUG]', {
                    hospitalId,
                    vagosAptoFinal,
                    vagosEnfFemFinal,
                    vagosEnfMascFinal,
                    disponiveis_apartamento: vagosAptoFinal,
                    disponiveis_enf_feminina: vagosEnfFemFinal,
                    disponiveis_enf_masculina: vagosEnfMascFinal
                }) ? {} : {}),
                tph: {
                    medio: tphMedio,
                    lista: leitosMais5Diarias
                },
                pps: {
                    medio: ppsMedio,
                    menor40: ppsMenor40
                },
                spict: {
                    elegiveis: spictElegiveis.length,
                    diretivas: diretivasPendentes.length,
                    listaDiretivas: diretivasPendentes
                }
            };
        }

        // =================== RENDER DASHBOARD EXECUTIVO ===================
        
        function renderKPIExecutivo() {
            const hospitais = ['H1', 'H2', 'H3', 'H4', 'H5'].map(processarDadosHospital);
            
            // Consolidar dados
            const totalLeitos = hospitais.reduce((sum, h) => sum + h.totalLeitos, 0);
            const totalOcupados = hospitais.reduce((sum, h) => sum + h.ocupados.total, 0);
            const totalPrevisao = hospitais.reduce((sum, h) => sum + h.previsao.total, 0);
            const totalDisponiveis = hospitais.reduce((sum, h) => sum + h.disponiveis.total, 0);
            const taxaOcupacao = (totalOcupados / totalLeitos * 100);
            
            // Consolidar por tipo
            const previsaoApto = hospitais.reduce((sum, h) => sum + h.previsao.apartamento, 0);
            const previsaoEnfFem = hospitais.reduce((sum, h) => sum + h.previsao.enf_feminina, 0);
            const previsaoEnfMasc = hospitais.reduce((sum, h) => sum + h.previsao.enf_masculina, 0);
            
            const disponiveisApto = hospitais.reduce((sum, h) => sum + h.disponiveis.apartamento, 0);
            const disponiveisEnfFem = hospitais.reduce((sum, h) => sum + h.disponiveis.enf_feminina, 0);
            const disponiveisEnfMasc = hospitais.reduce((sum, h) => sum + h.disponiveis.enf_masculina, 0);
            
            // Consolidar modalidades
            const modalidadePrevisao = {
                flexiveis: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.flexiveis, 0),
                exclusivo_apto: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_apto, 0),
                exclusivo_enf_sem_restricao: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_sem_restricao, 0),
                exclusivo_enf_fem: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_fem, 0),
                exclusivo_enf_masc: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_masc, 0)
            };
            
            const modalidadeDisponiveis = {
                flexiveis: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.flexiveis, 0),
                exclusivo_apto: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_apto, 0),
                exclusivo_enf_sem_restricao: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_sem_restricao, 0),
                exclusivo_enf_fem: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_fem, 0),
                exclusivo_enf_masc: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_masc, 0)
            };
            
            // TPH médio
            const tphTodos = hospitais.map(h => parseFloat(h.tph.medio)).filter(v => v > 0);
            const tphMedioGeral = tphTodos.length > 0 
                ? (tphTodos.reduce((a, b) => a + b, 0) / tphTodos.length).toFixed(1)
                : 0;
            
            // PPS médio
            const ppsTodos = hospitais.map(h => h.pps.medio).filter(v => v > 0);
            const ppsMedioGeral = ppsTodos.length > 0
                ? Math.round(ppsTodos.reduce((a, b) => a + b, 0) / ppsTodos.length)
                : 0;
            const totalPPSMenor40 = hospitais.reduce((sum, h) => sum + h.pps.menor40.length, 0);
            
            // SPICT
            const totalSpict = hospitais.reduce((sum, h) => sum + h.spict.elegiveis, 0);
            const totalDiretivas = hospitais.reduce((sum, h) => sum + h.spict.diretivas, 0);
            
            return `
                <div class="dashboard-section executivo">
                    <div class="dashboard-header-section">
                        <h2>Dashboard Executivo</h2>
                        <span class="badge executivo">Rede Externa</span>
                    </div>
                    
                    <div class="kpis-grid">
                        <!-- BOX 1: Ocupação Geral -->
                        <div class="kpi-box box-ocupacao-geral">
                            <div class="kpi-title">Ocupação Geral - Rede Externa</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeLargo(taxaOcupacao, totalOcupados)}
                            </div>
                            
                            <div class="kpi-detalhes">
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Leitos Fixos</th>
                                            <th>Leitos Ocupados</th>
                                            <th>Taxa Ocupação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td><strong>${h.nome}</strong></td>
                                                <td>${h.totalLeitos}</td>
                                                <td>${h.ocupados.total}</td>
                                                <td>${h.taxaOcupacao.toFixed(1)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 2: Previsão de Alta -->
                        <div class="kpi-box box-previsao">
                            <div class="kpi-title">Leitos em Previsão de Alta</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((totalPrevisao / totalLeitos * 100), '#f97316', totalPrevisao)}
                                
                                <div class="kpi-items-lista">
                                    <div class="kpi-subtitle">Total de Leitos com alta na data de hoje</div>
                                    <div class="item-lista">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${previsaoApto}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${previsaoEnfFem}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${previsaoEnfMasc}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Leitos Divididos Conforme Modalidade Contratual com o Credenciado</div>
                                ${renderModalidadeContratual(modalidadePrevisao)}
                            </div>
                        </div>

                        <!-- BOX 3: Disponíveis -->
                        <div class="kpi-box box-disponiveis">
                            <div class="kpi-title">Leitos Disponíveis</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((totalDisponiveis / totalLeitos * 100), '#3b82f6', totalDisponiveis)}
                                
                                <div class="kpi-items-lista">
                                    <div class="kpi-subtitle">Capacidade por tipo de leito (não simultâneo)</div>
                                    <div class="item-lista">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">até ${disponiveisApto}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">até ${disponiveisEnfFem}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">até ${disponiveisEnfMasc}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Leitos Divididos Conforme Modalidade Contratual com o Credenciado</div>
                                ${renderModalidadeContratual(modalidadeDisponiveis)}
                            </div>
                        </div>

                        <!-- BOX 4: TPH -->
                        <div class="kpi-box box-tph">
                            <div class="kpi-title">TPH Médio</div>
                            
                            <div class="kpi-tph-container">
                                <div class="kpi-tph-numero">${tphMedioGeral}</div>
                                <div class="kpi-tph-label">dias</div>
                                ${renderMiniGaugeTPH(parseFloat(tphMedioGeral))}
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">TPH (dias)</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>TPH (dias)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td>${h.nome}</td>
                                                <td>${h.tph.medio}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 5: PPS -->
                        <div class="kpi-box box-pps">
                            <div class="kpi-title">PPS</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${ppsMedioGeral}</div>
                                    <div class="label">PPS Médio</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalPPSMenor40.toString().padStart(2, '0')}</div>
                                    <div class="label">PPS < 40%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">PPS < 40% por Hospital</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>PPS < 40%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td>${h.nome}</td>
                                                <td>${h.pps.menor40.length}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 6: SPICT -->
                        <div class="kpi-box box-spict">
                            <div class="kpi-title">SPICT-BR | Diretivas</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalSpict.toString().padStart(2, '0')}</div>
                                    <div class="label">SPICT-BR</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalDiretivas.toString().padStart(2, '0')}</div>
                                    <div class="label">Diretivas</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Diretivas Pendentes por Hospital</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>Diretivas Pendentes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td>${h.nome}</td>
                                                <td>${h.spict.diretivas}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== RENDER DASHBOARD HOSPITALAR ===================
        
        function renderKPIHospitalar(hospitalId) {
            const dados = processarDadosHospital(hospitalId);
            
            return `
                <div class="dashboard-section hospitalar">
                    <div class="dashboard-header-section">
                        <h2>${dados.nome}</h2>
                        <span class="badge hospital">${hospitalId}</span>
                    </div>
                    
                    <div class="kpis-grid">
                        <!-- BOX 1: Leitos Ocupados -->
                        <div class="kpi-box box-ocupados">
                            <div class="kpi-title">Leitos Ocupados</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5(dados.taxaOcupacao, '#22c55e', dados.ocupados.total)}
                                
                                <div class="kpi-items-lista">
                                    <div class="item-lista">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${dados.ocupados.apartamento}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${dados.ocupados.enf_feminina}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${dados.ocupados.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.ocupados.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 2: Previsão de Alta -->
                        <div class="kpi-box box-previsao">
                            <div class="kpi-title">Leitos em Previsão de Alta</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((dados.previsao.total / dados.totalLeitos * 100), '#f97316', dados.previsao.total)}
                                
                                <div class="kpi-items-lista">
                                    <div class="kpi-subtitle">Total de Leitos com alta na data de hoje</div>
                                    <div class="item-lista">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${dados.previsao.apartamento}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${dados.previsao.enf_feminina}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${dados.previsao.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.previsao.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 3: Disponíveis -->
                        <div class="kpi-box box-disponiveis">
                            <div class="kpi-title">Leitos Disponíveis</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((dados.disponiveis.total / dados.totalLeitos * 100), '#3b82f6', dados.disponiveis.total)}
                                
                                <div class="kpi-items-lista">
                                    <div class="kpi-subtitle">Capacidade por tipo de leito (não simultâneo)</div>
                                    <div class="item-lista">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">até ${dados.disponiveis.apartamento}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">até ${dados.disponiveis.enf_feminina}</span>
                                    </div>
                                    <div class="item-lista">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">até ${dados.disponiveis.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.disponiveis.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 4: TPH -->
                        <div class="kpi-box box-tph">
                            <div class="kpi-title">TPH Médio</div>
                            
                            <div class="kpi-tph-container">
                                <div class="kpi-tph-numero">${dados.tph.medio}</div>
                                <div class="kpi-tph-label">dias</div>
                                ${renderMiniGaugeTPH(parseFloat(dados.tph.medio))}
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Nº Diárias > 5</div>
                                ${dados.tph.lista.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matrícula</th>
                                                <th>Dias</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.tph.lista.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                    <td>${l.dias}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhum leito com mais de 5 diárias</div>'}
                            </div>
                        </div>

                        <!-- BOX 5: PPS -->
                        <div class="kpi-box box-pps">
                            <div class="kpi-title">PPS</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.pps.medio}</div>
                                    <div class="label">PPS Médio</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.pps.menor40.length.toString().padStart(2, '0')}</div>
                                    <div class="label">PPS < 40%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">PPS < 40%</div>
                                ${dados.pps.menor40.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matrícula</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.pps.menor40.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhum leito com PPS < 40%</div>'}
                            </div>
                        </div>

                        <!-- BOX 6: SPICT -->
                        <div class="kpi-box box-spict">
                            <div class="kpi-title">SPICT-BR | Diretivas</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.spict.elegiveis.toString().padStart(2, '0')}</div>
                                    <div class="label">SPICT-BR</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.spict.diretivas.toString().padStart(2, '0')}</div>
                                    <div class="label">Diretivas</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Diretivas Pendentes</div>
                                ${dados.spict.listaDiretivas.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matrícula</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.spict.listaDiretivas.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhuma diretiva pendente</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== FUNÇÕES PRINCIPAIS ===================
        
        async function carregarDados() {
            try {
                console.log('Carregando dados...');
                
                if (typeof window.loadHospitalData === 'function') {
                    await window.loadHospitalData();
                } else {
                    throw new Error('Função loadHospitalData não encontrada');
                }
                
                document.getElementById('timestamp').textContent = 'Atualizado em: ' + formatarData();
                
                document.getElementById('kpi-executivo').innerHTML = renderKPIExecutivo();
                
                let htmlHospitalares = '';
                ['H1', 'H2', 'H3', 'H4', 'H5'].forEach(hospitalId => {
                    htmlHospitalares += renderKPIHospitalar(hospitalId);
                });
                document.getElementById('kpis-hospitalares').innerHTML = htmlHospitalares;
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                console.log('Dados carregados com sucesso!');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #ef4444;">Erro ao carregar dados</p>
                    <p style="color: #9ca3af; font-size: 14px; margin-top: 10px;">${error.message}</p>
                    <button class="btn btn-reload" onclick="carregarDados()" style="margin-top: 20px;">
                        Tentar Novamente
                    </button>
                `;
            }
        }

        function recarregarDados() {
            document.getElementById('content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `
                <div class="loading-spinner"></div>
                <p>Recarregando dados da planilha...</p>
            `;
            
            window.apiCache = {};
            window.hospitalData = {};
            
            carregarDados();
        }

        function copiarParaWhatsApp() {
            const hospitais = ['H1', 'H2', 'H3', 'H4', 'H5'].map(processarDadosHospital);
            
            const totalLeitos = hospitais.reduce((sum, h) => sum + h.totalLeitos, 0);
            const totalOcupados = hospitais.reduce((sum, h) => sum + h.ocupados.total, 0);
            const taxaOcupacao = ((totalOcupados / totalLeitos) * 100).toFixed(1);
            
            let texto = `*KPIs ARCHIPELAGO*\n`;
            texto += `${formatarData()}\n\n`;
            
            texto += `*REDE EXTERNA (5 HOSPITAIS)*\n`;
            texto += `━━━━━━━━━━━━━━━━━\n`;
            texto += `Taxa de Ocupação: *${taxaOcupacao}%*\n`;
            texto += `Leitos Ocupados: *${totalOcupados}/${totalLeitos}*\n\n`;
            
            hospitais.forEach((h, index) => {
                texto += `*${index + 1}. ${h.nome}*\n`;
                texto += `• Taxa: ${h.taxaOcupacao.toFixed(1)}%\n`;
                texto += `• Ocupados: ${h.ocupados.total}/${h.totalLeitos}\n`;
                texto += `• Previsão Alta: ${h.previsao.total}\n`;
                texto += `• Disponíveis: ${h.disponiveis.total}\n`;
                texto += `• TPH: ${h.tph.medio} dias\n`;
                texto += `• PPS Médio: ${h.pps.medio}\n`;
                texto += `• SPICT: ${h.spict.elegiveis} | Diretivas: ${h.spict.diretivas}\n`;
                texto += `\n_Modalidades Disponíveis:_\n`;
                texto += `  Flexíveis: ${h.disponiveis.modalidade.flexiveis}\n`;
                texto += `  Exclus. Apto: ${h.disponiveis.modalidade.exclusivo_apto}\n`;
                texto += `  Exclus. Enf s/ Restr: ${h.disponiveis.modalidade.exclusivo_enf_sem_restricao}\n`;
                texto += `  Exclus. Enf Fem: ${h.disponiveis.modalidade.exclusivo_enf_fem}\n`;
                texto += `  Exclus. Enf Masc: ${h.disponiveis.modalidade.exclusivo_enf_masc}\n`;
                if (index < hospitais.length - 1) texto += `\n`;
            });
            
            navigator.clipboard.writeText(texto).then(() => {
                alert('Texto copiado para a área de transferência!\n\nCole no WhatsApp e envie.');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar. Tente novamente.');
            });
        }

        // =================== FUNÇÕES DO MENU ===================
        
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            menu.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        function closeMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            menu.classList.remove('open');
            overlay.classList.remove('active');
        }

        // =================== INICIALIZAÇÃO ===================
        
        window.addEventListener('load', () => {
            setTimeout(carregarDados, 500);
        });
    </script>
</body>
</html>
