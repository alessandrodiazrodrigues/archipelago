<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Archipelago - Relatório Consolidado</title>
    
    <!-- API Script -->
    <script src="js/api.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* =================== HEADER =================== */
        .page-header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #60a5fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-header h1 {
            color: #60a5fa;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .page-header .timestamp {
            color: #9ca3af;
            font-size: 14px;
        }

        /* =================== BOTÕES DE AÇÃO =================== */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-print {
            background: #22c55e;
            color: white;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-reload {
            background: #3b82f6;
            color: white;
        }

        /* =================== LOADING =================== */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .loading-spinner {
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =================== DASHBOARD SECTION =================== */
        .dashboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            page-break-inside: avoid;
        }

        .dashboard-section.executivo {
            border-left: 4px solid #8b5cf6;
        }

        .dashboard-section.hospitalar {
            border-left: 4px solid #60a5fa;
        }

        .dashboard-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-header-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
        }

        .dashboard-header-section .badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.executivo {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid #8b5cf6;
        }

        .badge.hospital {
            background: rgba(96, 165, 250, 0.2);
            color: #93c5fd;
            border: 1px solid #60a5fa;
        }

        /* =================== KPI GRID (3 COLUNAS) =================== */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kpis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* =================== KPI BOX =================== */
        .kpi-box {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .kpi-box:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        /* Cores por tipo de box */
        .kpi-box.box-ocupados {
            border-top: 3px solid #22c55e;
        }

        .kpi-box.box-previsao {
            border-top: 3px solid #f97316;
        }

        .kpi-box.box-disponiveis {
            border-top: 3px solid #3b82f6;
        }

        .kpi-box.box-tph {
            border-top: 3px solid #8b5cf6;
        }

        .kpi-box.box-pps {
            border-top: 3px solid #ec4899;
        }

        .kpi-box.box-spict {
            border-top: 3px solid #14b8a6;
        }

        /* =================== KPI TITLE =================== */
        .kpi-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* =================== KPI CONTENT =================== */
        .kpi-content {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex: 1;
        }

        .kpi-content-centered {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .kpi-content-centered-large {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        /* =================== GAUGE V5 (MEIA ROSCA) =================== */
        .v5-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .v5-gauge {
            width: 120px;
            height: 70px;
        }

        .v5-number-inside {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 39px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .v5-badge-below {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .v5-badge-below.green {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .v5-badge-below.orange {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border: 1px solid #f97316;
        }

        .v5-badge-below.blue {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        /* =================== GAUGE LARGO (EXECUTIVO) =================== */
        .gauge-largo-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 200px;
            margin: 0 auto;
        }

        .gauge-largo-info {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 35px;
        }

        .gauge-largo-percentage {
            font-size: 54px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .gauge-largo-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-top: 6px;
        }

        .gauge-largo-number {
            font-size: 48px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
            margin-top: 6px;
        }

        .gauge-largo-subtitle {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
            margin-top: 8px;
            text-align: center;
            line-height: 1.3;
        }

        /* =================== KPI VALUE =================== */
        .kpi-value-principal {
            font-size: 72px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
            text-align: center;
        }

        .kpi-percent-only {
            font-size: 72px;
            font-weight: 700;
            color: #ffffff;
            text-align: center;
            margin: 40px 0;
        }

        /* =================== KPI VALORES DUPLOS =================== */
        .kpi-valores-duplos-divididos {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            align-items: center;
            justify-content: center;
        }

        .kpi-valor-metade {
            text-align: center;
            flex: 1;
        }

        .kpi-valor-metade .valor {
            font-size: 64px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .kpi-valor-metade .label {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 8px;
        }

        .divisor-vertical {
            width: 1px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* =================== KPI ITEMS LATERAL =================== */
        .kpi-items-lateral {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .kpi-items-lateral-centered {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
        }

        .item-lateral {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .item-lateral .label {
            font-size: 13px;
            color: #d1d5db;
        }

        .item-lateral .valor {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        /* =================== KPI DETALHES =================== */
        .kpi-detalhes {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: auto;
        }

        .detalhe-titulo {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* =================== LISTA SIMPLES COMPACTA =================== */
        .lista-simples-compacta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lista-item-compacto {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 10px;
            font-size: 12px;
        }

        .lista-item-compacto .label {
            color: #d1d5db;
        }

        .lista-item-compacto .valor {
            font-weight: 600;
            color: #ffffff;
        }

        /* =================== TABELAS =================== */
        .hospitais-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .hospitais-table th {
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            padding: 10px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #60a5fa;
        }

        .hospitais-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #d1d5db;
        }

        .hospitais-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .hospitais-table .hospital-name-nowrap {
            white-space: nowrap;
            color: #93c5fd;
            font-weight: 600;
        }

        /* =================== SEM DADOS =================== */
        .sem-dados {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 13px;
            font-style: italic;
        }

        /* =================== PRINT STYLES =================== */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body {
                background: white;
                color: black;
                padding: 0;
            }

            .action-buttons,
            .btn {
                display: none !important;
            }

            .dashboard-section {
                page-break-inside: avoid;
                border: 1px solid #ddd;
                background: white;
                margin-bottom: 20px;
            }

            .kpi-box {
                border: 1px solid #ddd;
                background: white;
                page-break-inside: avoid;
            }

            .page-header {
                background: white;
                border: 1px solid #ddd;
            }

            .page-header h1,
            .dashboard-header-section h2,
            .kpi-title,
            .kpi-value-principal,
            .kpi-valor-metade .valor,
            .gauge-largo-percentage,
            .gauge-largo-number,
            .v5-number-inside {
                color: black !important;
            }

            .badge {
                border: 1px solid #999;
            }

            * {
                color-adjust: exact;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- HEADER -->
        <div class="page-header">
            <div>
                <h1>KPIs ARCHIPELAGO</h1>
                <p class="timestamp" id="timestamp">Carregando...</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-reload" onclick="recarregarDados()">
                    Atualizar
                </button>
                <button class="btn btn-print" onclick="window.print()">
                    Imprimir
                </button>
                <button class="btn btn-whatsapp" onclick="copiarParaWhatsApp()">
                    Copiar para WhatsApp
                </button>
            </div>
        </div>

        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Carregando dados da planilha...</p>
        </div>

        <!-- CONTENT -->
        <div id="content" style="display: none;">
            <!-- KPI EXECUTIVO V2 -->
            <div id="kpi-executivo"></div>

            <!-- KPIs HOSPITALARES (5) -->
            <div id="kpis-hospitalares"></div>
        </div>
    </div>

    <script>
        // =================== FUNÇÕES UTILITÁRIAS ===================
        
        function formatarData() {
            const agora = new Date();
            const opcoes = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return agora.toLocaleDateString('pt-BR', opcoes);
        }

        function calcularGaugeOffset(porcentagem) {
            const circunferencia = Math.PI * 55; // Meia rosca
            const progresso = (porcentagem / 100) * circunferencia;
            return circunferencia - progresso;
        }

        function calcularGaugeLargoOffset(porcentagem) {
            const circunferencia = Math.PI * 180; // Gauge largo
            const progresso = (porcentagem / 100) * circunferencia;
            return circunferencia - progresso;
        }

        // =================== RENDER GAUGE V5 (MEIA ROSCA) ===================
        
        function renderGaugeV5(porcentagem, cor, numero) {
            const offset = calcularGaugeOffset(porcentagem);
            const badgeClass = cor === '#22c55e' ? 'green' : (cor === '#f97316' ? 'orange' : 'blue');
            
            return `
                <div class="v5-gauge-container">
                    <div style="position: relative;">
                        <svg class="v5-gauge" viewBox="0 0 140 80">
                            <!-- Fundo cinza -->
                            <path d="M 15 70 A 55 55 0 0 1 125 70" 
                                  fill="none" 
                                  stroke="rgba(255,255,255,0.1)" 
                                  stroke-width="14" 
                                  stroke-linecap="round"/>
                            <!-- Progresso -->
                            <path d="M 15 70 A 55 55 0 0 1 125 70" 
                                  fill="none" 
                                  stroke="${cor}" 
                                  stroke-width="14" 
                                  stroke-linecap="round"
                                  stroke-dasharray="172.8"
                                  stroke-dashoffset="${offset}"/>
                        </svg>
                        <div class="v5-number-inside">${numero.toString().padStart(2, '0')}</div>
                    </div>
                    <div class="v5-badge-below ${badgeClass}">${porcentagem.toFixed(0)}%</div>
                </div>
            `;
        }

        // =================== RENDER GAUGE LARGO (EXECUTIVO) ===================
        
        function renderGaugeLargo(porcentagem, numeroTotal) {
            const offset = calcularGaugeLargoOffset(porcentagem);
            
            return `
                <div style="display: flex; justify-content: center; margin: 60px 0 50px 0; padding-top: 20px;">
                    <div class="gauge-largo-container">
                        <!-- SVG Gauge Largo -->
                        <svg viewBox="0 0 450 220" style="width: 100%; height: 100%;">
                            <!-- Fundo cinza -->
                            <path d="M 40 180 A 180 180 0 0 1 410 180" 
                                  fill="none" 
                                  stroke="rgba(255,255,255,0.1)" 
                                  stroke-width="25" 
                                  stroke-linecap="round"/>
                            <!-- Progresso verde -->
                            <path d="M 40 180 A 180 180 0 0 1 410 180" 
                                  fill="none" 
                                  stroke="#22c55e" 
                                  stroke-width="25" 
                                  stroke-linecap="round"
                                  stroke-dasharray="565.5"
                                  stroke-dashoffset="${offset}"/>
                        </svg>
                        
                        <!-- Informações dentro do gauge -->
                        <div class="gauge-largo-info">
                            <div class="gauge-largo-percentage">${porcentagem.toFixed(0)}%</div>
                            <div class="gauge-largo-label">LEITOS OCUPADOS</div>
                            <div class="gauge-largo-number">${numeroTotal}</div>
                            <div class="gauge-largo-subtitle">
                                Total da Rede Externa<br/>(5 Hospitais)
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== RENDER MODALIDADE CONTRATUAL ===================
        
        function renderModalidadeContratual(modalidade) {
            return `
                <div class="lista-simples-compacta">
                    <div class="lista-item-compacto">
                        <span class="label">Flexíveis quanto ao plano</span>
                        <span class="valor">${modalidade.flexiveis || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclusivamente Apartamentos</span>
                        <span class="valor">${modalidade.exclusivo_apto || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf sem Restrição</span>
                        <span class="valor">${modalidade.exclusivo_enf_sem_restricao || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf Feminina</span>
                        <span class="valor">${modalidade.exclusivo_enf_fem || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf Masculina</span>
                        <span class="valor">${modalidade.exclusivo_enf_masc || 0}</span>
                    </div>
                </div>
            `;
        }

        // =================== PROCESSAR DADOS DA PLANILHA ===================
        
        function processarDadosHospital(hospitalId) {
            const hospitalObj = window.hospitalData[hospitalId] || {};
            
            // Debug: verificar estrutura dos dados
            console.log(`Processando ${hospitalId}:`, hospitalObj);
            
            // Garantir que leitos é um array
            let leitos = hospitalObj.leitos || hospitalObj || [];
            if (!Array.isArray(leitos)) {
                console.warn(`${hospitalId}: leitos não é array, convertendo...`);
                leitos = [];
            }
            
            console.log(`${hospitalId}: ${leitos.length} leitos encontrados`);
            
            // Calcular ocupados
            const ocupados = leitos.filter(l => l.status === 'ocupado');
            // Calcular ocupados por tipo (considerando diferentes nomenclaturas)
            const ocupadosApto = ocupados.filter(l => 
                l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'Híbrido'
            ).length;
            const ocupadosEnfFem = ocupados.filter(l => 
                l.tipo === 'Enfermaria Feminina' || l.tipo === 'ENFERMARIA'
            ).length;
            const ocupadosEnfMasc = ocupados.filter(l => 
                l.tipo === 'Enfermaria Masculina' || l.tipo === 'ENFERMARIA'
            ).length;
            
            // Calcular previsão de alta
            const previsaoAlta = leitos.filter(l => l.prevAlta && l.prevAlta.trim() !== '');
            const previsaoApto = previsaoAlta.filter(l => 
                l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'Híbrido'
            ).length;
            const previsaoEnfFem = previsaoAlta.filter(l => 
                l.tipo === 'Enfermaria Feminina' || l.tipo === 'ENFERMARIA'
            ).length;
            const previsaoEnfMasc = previsaoAlta.filter(l => 
                l.tipo === 'Enfermaria Masculina' || l.tipo === 'ENFERMARIA'
            ).length;
            
            // Calcular disponíveis
            const vagos = leitos.filter(l => l.status === 'vago');
            const vagosApto = vagos.filter(l => 
                l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'Híbrido'
            ).length;
            const vagosEnfFem = vagos.filter(l => 
                l.tipo === 'Enfermaria Feminina' || l.tipo === 'ENFERMARIA'
            ).length;
            const vagosEnfMasc = vagos.filter(l => 
                l.tipo === 'Enfermaria Masculina' || l.tipo === 'ENFERMARIA'
            ).length;
            
            // TPH médio
            const tphValues = ocupados
                .map(l => {
                    if (!l.admAt) return 0;
                    const admData = new Date(l.admAt);
                    const hoje = new Date();
                    const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                    return dias > 0 ? dias : 0;
                })
                .filter(v => v > 0);
            const tphMedio = tphValues.length > 0 
                ? (tphValues.reduce((a, b) => a + b, 0) / tphValues.length).toFixed(1)
                : 0;
            
            const leitosMais5Diarias = ocupados.filter(l => {
                if (!l.admAt) return false;
                const admData = new Date(l.admAt);
                const hoje = new Date();
                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                return dias > 5;
            }).map(l => {
                const admData = new Date(l.admAt);
                const hoje = new Date();
                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                return { ...l, dias };
            });
            
            // PPS
            const ppsValues = ocupados
                .map(l => parseInt(l.pps) || 0)
                .filter(v => v > 0);
            const ppsMedio = ppsValues.length > 0
                ? Math.round(ppsValues.reduce((a, b) => a + b, 0) / ppsValues.length)
                : 0;
            const ppsMenor40 = ocupados.filter(l => parseInt(l.pps) < 40);
            
            // SPICT
            const spictElegiveis = ocupados.filter(l => 
                l.spict && l.spict.toLowerCase() === 'elegivel'
            );
            const diretivasPendentes = ocupados.filter(l => 
                l.spict && l.spict.toLowerCase() === 'elegivel' && (!l.diretivas || l.diretivas.trim() === '' || l.diretivas === 'Não')
            );
            
            // Calcular taxa de ocupação
            const totalLeitos = leitos.length;
            const taxaOcupacao = totalLeitos > 0 ? (ocupados.length / totalLeitos * 100) : 0;
            
            // Modalidade contratual (simplificado - todos como flexíveis por enquanto)
            const modalidadeOcupados = {
                flexiveis: ocupados.filter(l => !l.categoria_escolhida || l.categoria_escolhida === '').length,
                exclusivo_apto: ocupados.filter(l => l.categoria_escolhida === 'Apartamento').length,
                exclusivo_enf_sem_restricao: ocupados.filter(l => l.categoria_escolhida === 'Enfermaria sem Restrição').length,
                exclusivo_enf_fem: ocupados.filter(l => l.categoria_escolhida === 'Enfermaria Feminina').length,
                exclusivo_enf_masc: ocupados.filter(l => l.categoria_escolhida === 'Enfermaria Masculina').length
            };
            
            const modalidadePrevisao = {
                flexiveis: previsaoAlta.filter(l => !l.categoria_escolhida || l.categoria_escolhida === '').length,
                exclusivo_apto: previsaoAlta.filter(l => l.categoria_escolhida === 'Apartamento').length,
                exclusivo_enf_sem_restricao: previsaoAlta.filter(l => l.categoria_escolhida === 'Enfermaria sem Restrição').length,
                exclusivo_enf_fem: previsaoAlta.filter(l => l.categoria_escolhida === 'Enfermaria Feminina').length,
                exclusivo_enf_masc: previsaoAlta.filter(l => l.categoria_escolhida === 'Enfermaria Masculina').length
            };
            
            const modalidadeDisponiveis = {
                flexiveis: vagos.filter(l => !l.categoria_escolhida || l.categoria_escolhida === '').length,
                exclusivo_apto: vagos.filter(l => l.categoria_escolhida === 'Apartamento').length,
                exclusivo_enf_sem_restricao: vagos.filter(l => l.categoria_escolhida === 'Enfermaria sem Restrição').length,
                exclusivo_enf_fem: vagos.filter(l => l.categoria_escolhida === 'Enfermaria Feminina').length,
                exclusivo_enf_masc: vagos.filter(l => l.categoria_escolhida === 'Enfermaria Masculina').length
            };
            
            return {
                nome: hospitalId === 'H1' ? 'ADVENTISTA' :
                      hospitalId === 'H2' ? 'CRUZ AZUL' :
                      hospitalId === 'H3' ? 'NEOMATER' :
                      hospitalId === 'H4' ? 'S. CLARA' :
                      'S. MARCELINA',
                totalLeitos: totalLeitos,
                taxaOcupacao: taxaOcupacao,
                ocupados: {
                    total: ocupados.length,
                    apartamento: ocupadosApto,
                    enf_feminina: ocupadosEnfFem,
                    enf_masculina: ocupadosEnfMasc,
                    modalidade: modalidadeOcupados
                },
                previsao: {
                    total: previsaoAlta.length,
                    apartamento: previsaoApto,
                    enf_feminina: previsaoEnfFem,
                    enf_masculina: previsaoEnfMasc,
                    modalidade: modalidadePrevisao
                },
                disponiveis: {
                    total: vagos.length,
                    apartamento: vagosApto,
                    enf_feminina: vagosEnfFem,
                    enf_masculina: vagosEnfMasc,
                    modalidade: modalidadeDisponiveis
                },
                tph: {
                    medio: tphMedio,
                    leitosMais5: leitosMais5Diarias
                },
                pps: {
                    medio: ppsMedio,
                    menor40: ppsMenor40
                },
                spict: {
                    elegiveis: spictElegiveis.length,
                    diretivas: diretivasPendentes.length,
                    listaDiretivas: diretivasPendentes
                }
            };
        }

        // =================== RENDER KPI EXECUTIVO V2 ===================
        
        function renderKPIExecutivo() {
            const hospitais = ['H1', 'H2', 'H3', 'H4', 'H5'].map(processarDadosHospital);
            
            // Consolidar dados
            const totalLeitos = hospitais.reduce((sum, h) => sum + h.totalLeitos, 0);
            const totalOcupados = hospitais.reduce((sum, h) => sum + h.ocupados.total, 0);
            const taxaOcupacaoGeral = totalLeitos > 0 ? (totalOcupados / totalLeitos * 100) : 0;
            
            const totalPrevisao = hospitais.reduce((sum, h) => sum + h.previsao.total, 0);
            const previsaoApto = hospitais.reduce((sum, h) => sum + h.previsao.apartamento, 0);
            const previsaoEnfFem = hospitais.reduce((sum, h) => sum + h.previsao.enf_feminina, 0);
            const previsaoEnfMasc = hospitais.reduce((sum, h) => sum + h.previsao.enf_masculina, 0);
            
            const totalDisponiveis = hospitais.reduce((sum, h) => sum + h.disponiveis.total, 0);
            const disponiveisApto = hospitais.reduce((sum, h) => sum + h.disponiveis.apartamento, 0);
            const disponiveisEnfFem = hospitais.reduce((sum, h) => sum + h.disponiveis.enf_feminina, 0);
            const disponiveisEnfMasc = hospitais.reduce((sum, h) => sum + h.disponiveis.enf_masculina, 0);
            
            const tphMedio = (hospitais.reduce((sum, h) => sum + parseFloat(h.tph.medio), 0) / hospitais.length).toFixed(1);
            
            const ppsValues = hospitais.map(h => h.pps.medio).filter(v => v > 0);
            const ppsMedio = ppsValues.length > 0 
                ? Math.round(ppsValues.reduce((a, b) => a + b, 0) / ppsValues.length)
                : 0;
            const totalPpsMenor40 = hospitais.reduce((sum, h) => sum + h.pps.menor40.length, 0);
            
            const totalSpict = hospitais.reduce((sum, h) => sum + h.spict.elegiveis, 0);
            const totalDiretivas = hospitais.reduce((sum, h) => sum + h.spict.diretivas, 0);
            
            // Modalidades consolidadas
            const modalidadePrevisao = {
                flexiveis: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.flexiveis, 0),
                exclusivo_apto: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_apto, 0),
                exclusivo_enf_sem_restricao: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_sem_restricao, 0),
                exclusivo_enf_fem: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_fem, 0),
                exclusivo_enf_masc: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_masc, 0)
            };
            
            const modalidadeDisponiveis = {
                flexiveis: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.flexiveis, 0),
                exclusivo_apto: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_apto, 0),
                exclusivo_enf_sem_restricao: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_sem_restricao, 0),
                exclusivo_enf_fem: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_fem, 0),
                exclusivo_enf_masc: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_masc, 0)
            };
            
            return `
                <div class="dashboard-section executivo">
                    <div class="dashboard-header-section">
                        <h2>DASHBOARD EXECUTIVO - REDE EXTERNA</h2>
                        <span class="badge executivo">Consolidado</span>
                    </div>
                    
                    <div class="kpis-grid">
                        <!-- BOX 1: OCUPAÇÃO GERAL COM GAUGE LARGO -->
                        <div class="kpi-box box-ocupados" style="min-height: 660px;">
                            <div class="kpi-title">Ocupação Geral - Rede Externa</div>
                            
                            ${renderGaugeLargo(taxaOcupacaoGeral, totalOcupados)}
                            
                            <!-- Tabela -->
                            <div class="kpi-detalhes" style="padding-top: 0; border-top: none; margin-top: 0;">
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Leitos Fixos</th>
                                            <th>Leitos Ocupados</th>
                                            <th>Taxa Ocupação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td class="hospital-name-nowrap"><strong>${h.nome}</strong></td>
                                                <td>${h.totalLeitos}</td>
                                                <td>${h.ocupados.total}</td>
                                                <td>${h.taxaOcupacao.toFixed(1)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 2: PREVISÃO DE ALTA -->
                        <div class="kpi-box box-previsao">
                            <div class="kpi-title">Leitos em Previsão de Alta</div>
                            
                            <div class="kpi-content-centered-large" style="min-height: 180px; margin-top: 25px;">
                                ${renderGaugeLargo((totalPrevisao / totalLeitos * 100), totalPrevisao)}
                                <div class="kpi-items-lateral-centered" style="margin-top: 20px;">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${previsaoApto}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${previsaoEnfFem}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${previsaoEnfMasc}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Leitos Divididos Conforme Modalidade Contratual com o Credenciado</div>
                                ${renderModalidadeContratual(modalidadePrevisao)}
                            </div>
                        </div>

                        <!-- BOX 3: DISPONÍVEIS -->
                        <div class="kpi-box box-disponiveis">
                            <div class="kpi-title">
                                Leitos Disponíveis
                                <div style="font-size: 10px; color: #9ca3af; margin-top: 6px; font-weight: 400; text-transform: none; letter-spacing: 0;">
                                    Capacidade por tipo de leito (não simultâneo)
                                </div>
                            </div>
                            
                            <div class="kpi-content-centered-large" style="min-height: 180px;">
                                ${renderGaugeLargo((totalDisponiveis / totalLeitos * 100), totalDisponiveis)}
                                <div class="kpi-items-lateral-centered" style="margin-top: 20px;">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">até ${disponiveisApto}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">até ${disponiveisEnfFem}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">até ${disponiveisEnfMasc}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Leitos Divididos Conforme Modalidade Contratual com o Credenciado</div>
                                ${renderModalidadeContratual(modalidadeDisponiveis)}
                            </div>
                        </div>

                        <!-- BOX 4: TPH -->
                        <div class="kpi-box box-tph">
                            <div class="kpi-title">TPH Médio</div>
                            
                            <div style="display: flex; justify-content: center; align-items: center; margin: 30px 0;">
                                <div style="text-align: center;">
                                    <div style="font-size: 72px; font-weight: 700; color: #ffffff; line-height: 1;">${tphMedio}</div>
                                    <div style="color: #9ca3af; font-size: 13px; margin-top: 8px;">dias</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">TPH (dias)</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>TPH (dias)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td class="hospital-name-nowrap"><strong>${h.nome}</strong></td>
                                                <td>${h.tph.medio}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 5: PPS -->
                        <div class="kpi-box box-pps">
                            <div class="kpi-title">PPS</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${ppsMedio}</div>
                                    <div class="label">PPS Médio</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalPpsMenor40.toString().padStart(2, '0')}</div>
                                    <div class="label">PPS < 40%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>PPS Médio</th>
                                            <th>PPS < 40%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td class="hospital-name-nowrap"><strong>${h.nome}</strong></td>
                                                <td>${h.pps.medio}</td>
                                                <td>${h.pps.menor40.length}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 6: SPICT -->
                        <div class="kpi-box box-spict">
                            <div class="kpi-title">SPICT-BR | Diretivas</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalSpict.toString().padStart(2, '0')}</div>
                                    <div class="label">SPICT-BR</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalDiretivas.toString().padStart(2, '0')}</div>
                                    <div class="label">Diretivas</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>SPICT-BR Elegíveis</th>
                                            <th>Diretivas Pendentes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td class="hospital-name-nowrap"><strong>${h.nome}</strong></td>
                                                <td>${h.spict.elegiveis}</td>
                                                <td>${h.spict.diretivas}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== RENDER KPI HOSPITALAR ===================
        
        function renderKPIHospitalar(hospitalId) {
            const dados = processarDadosHospital(hospitalId);
            
            // Calcular porcentagem de previsão de alta
            const porcentagemPrevisao = dados.ocupados.total > 0 
                ? (dados.previsao.total / dados.ocupados.total * 100)
                : 0;
            
            return `
                <div class="dashboard-section hospitalar">
                    <div class="dashboard-header-section">
                        <h2>${dados.nome}</h2>
                        <span class="badge hospital">${hospitalId}</span>
                    </div>
                    
                    <div class="kpis-grid">
                        <!-- BOX 1: OCUPADOS -->
                        <div class="kpi-box box-ocupados">
                            <div class="kpi-title">Leitos Ocupados</div>
                            
                            <div class="kpi-content-centered">
                                ${renderGaugeV5(dados.taxaOcupacao, '#22c55e', dados.ocupados.total)}
                                <div class="kpi-items-lateral">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${dados.ocupados.apartamento}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${dados.ocupados.enf_feminina}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${dados.ocupados.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.ocupados.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 2: PREVISÃO DE ALTA -->
                        <div class="kpi-box box-previsao">
                            <div class="kpi-title">Leitos em Previsão de Alta</div>
                            
                            <div class="kpi-content-centered">
                                ${renderGaugeV5(porcentagemPrevisao, '#f97316', dados.previsao.total)}
                                <div class="kpi-items-lateral">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${dados.previsao.apartamento}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${dados.previsao.enf_feminina}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${dados.previsao.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.previsao.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 3: DISPONÍVEIS -->
                        <div class="kpi-box box-disponiveis">
                            <div class="kpi-title">Leitos Disponíveis</div>
                            
                            <div class="kpi-content-centered">
                                ${renderGaugeV5(dados.disponiveis.total > 0 ? (dados.disponiveis.total / dados.totalLeitos * 100) : 0, '#3b82f6', dados.disponiveis.total)}
                                <div class="kpi-items-lateral">
                                    <div class="item-lateral" style="font-size: 11px; color: #9ca3af; margin-bottom: 5px;">
                                        Capacidade por tipo de leito (não simultâneo)
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">até ${dados.disponiveis.apartamento}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">até ${dados.disponiveis.enf_feminina}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">até ${dados.disponiveis.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.disponiveis.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 4: TPH -->
                        <div class="kpi-box box-tph">
                            <div class="kpi-title">TPH Médio</div>
                            
                            <div style="display: flex; justify-content: center; align-items: center; margin: 30px 0;">
                                <div style="text-align: center;">
                                    <div style="font-size: 72px; font-weight: 700; color: #ffffff; line-height: 1;">${dados.tph.medio}</div>
                                    <div style="color: #9ca3af; font-size: 13px; margin-top: 8px;">dias</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Nº Diárias > 5</div>
                                ${dados.tph.leitosMais5.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Diárias</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.tph.leitosMais5.map(l => {
                                                const admData = new Date(l.adm_at);
                                                const hoje = new Date();
                                                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                                                return `
                                                    <tr>
                                                        <td>${l.leito}</td>
                                                        <td>${dias}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhum leito com mais de 5 diárias</div>'}
                            </div>
                        </div>

                        <!-- BOX 5: PPS -->
                        <div class="kpi-box box-pps">
                            <div class="kpi-title">PPS</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.pps.medio}</div>
                                    <div class="label">PPS Médio</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.pps.menor40.length.toString().padStart(2, '0')}</div>
                                    <div class="label">PPS < 40%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">PPS < 40%</div>
                                ${dados.pps.menor40.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matrícula</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.pps.menor40.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhum leito com PPS < 40%</div>'}
                            </div>
                        </div>

                        <!-- BOX 6: SPICT -->
                        <div class="kpi-box box-spict">
                            <div class="kpi-title">SPICT-BR | Diretivas</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.spict.elegiveis.toString().padStart(2, '0')}</div>
                                    <div class="label">SPICT-BR</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.spict.diretivas.toString().padStart(2, '0')}</div>
                                    <div class="label">Diretivas</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Diretivas Pendentes</div>
                                ${dados.spict.listaDiretivas.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matrícula</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.spict.listaDiretivas.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhuma diretiva pendente</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== FUNÇÕES PRINCIPAIS ===================
        
        async function carregarDados() {
            try {
                console.log('Carregando dados...');
                
                // Carregar dados da API
                if (typeof window.loadHospitalData === 'function') {
                    await window.loadHospitalData();
                } else {
                    throw new Error('Função loadHospitalData não encontrada');
                }
                
                // Atualizar timestamp
                document.getElementById('timestamp').textContent = 'Atualizado em: ' + formatarData();
                
                // Renderizar conteúdo
                document.getElementById('kpi-executivo').innerHTML = renderKPIExecutivo();
                
                let htmlHospitalares = '';
                ['H1', 'H2', 'H3', 'H4', 'H5'].forEach(hospitalId => {
                    htmlHospitalares += renderKPIHospitalar(hospitalId);
                });
                document.getElementById('kpis-hospitalares').innerHTML = htmlHospitalares;
                
                // Mostrar conteúdo
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                console.log('Dados carregados com sucesso!');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #ef4444;">❌ Erro ao carregar dados</p>
                    <p style="color: #9ca3af; font-size: 14px; margin-top: 10px;">${error.message}</p>
                    <button class="btn btn-reload" onclick="carregarDados()" style="margin-top: 20px;">
                        Tentar Novamente
                    </button>
                `;
            }
        }

        function recarregarDados() {
            document.getElementById('content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `
                <div class="loading-spinner"></div>
                <p>Recarregando dados da planilha...</p>
            `;
            
            // Limpar cache
            window.apiCache = {};
            window.hospitalData = {};
            
            carregarDados();
        }

        function copiarParaWhatsApp() {
            const hospitais = ['H1', 'H2', 'H3', 'H4', 'H5'].map(processarDadosHospital);
            
            // Dados executivos
            const totalLeitos = hospitais.reduce((sum, h) => sum + h.totalLeitos, 0);
            const totalOcupados = hospitais.reduce((sum, h) => sum + h.ocupados.total, 0);
            const taxaOcupacao = ((totalOcupados / totalLeitos) * 100).toFixed(1);
            
            let texto = `🏥 *KPIs ARCHIPELAGO*\n`;
            texto += `📅 ${formatarData()}\n\n`;
            
            texto += `*📊 REDE EXTERNA (5 HOSPITAIS)*\n`;
            texto += `━━━━━━━━━━━━━━━━━\n`;
            texto += `Taxa de Ocupação: *${taxaOcupacao}%*\n`;
            texto += `Leitos Ocupados: *${totalOcupados}/${totalLeitos}*\n\n`;
            
            hospitais.forEach((h, index) => {
                texto += `*${index + 1}. ${h.nome}*\n`;
                texto += `• Taxa: ${h.taxaOcupacao.toFixed(1)}%\n`;
                texto += `• Ocupados: ${h.ocupados.total}/${h.totalLeitos}\n`;
                texto += `• Previsão Alta: ${h.previsao.total}\n`;
                texto += `• Disponíveis: ${h.disponiveis.total}\n`;
                texto += `• TPH: ${h.tph.medio} dias\n`;
                texto += `• PPS Médio: ${h.pps.medio}\n`;
                texto += `• SPICT: ${h.spict.elegiveis} | Diretivas: ${h.spict.diretivas}\n`;
                texto += `\n_Modalidades Disponíveis:_\n`;
                texto += `  Flexíveis: ${h.disponiveis.modalidade.flexiveis}\n`;
                texto += `  Exclus. Apto: ${h.disponiveis.modalidade.exclusivo_apto}\n`;
                texto += `  Exclus. Enf s/ Restr: ${h.disponiveis.modalidade.exclusivo_enf_sem_restricao}\n`;
                texto += `  Exclus. Enf Fem: ${h.disponiveis.modalidade.exclusivo_enf_fem}\n`;
                texto += `  Exclus. Enf Masc: ${h.disponiveis.modalidade.exclusivo_enf_masc}\n`;
                if (index < hospitais.length - 1) texto += `\n`;
            });
            
            // Copiar para clipboard
            navigator.clipboard.writeText(texto).then(() => {
                alert('✅ Texto copiado para a área de transferência!\n\nCole no WhatsApp e envie.');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('❌ Erro ao copiar. Tente novamente.');
            });
        }

        // =================== INICIALIZAÇÃO ===================
        
        window.addEventListener('load', () => {
            // Aguardar um pouco para garantir que api.js carregou
            setTimeout(carregarDados, 500);
        });
    </script>
</body>
</html>
