<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Archipelago - Relat√≥rio Consolidado</title>
    
    <!-- API Script -->
    <script src="js/api.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* =================== HEADER =================== */
        .page-header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #60a5fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-header h1 {
            color: #60a5fa;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .page-header .timestamp {
            color: #9ca3af;
            font-size: 14px;
        }

        /* =================== BOT√ïES DE A√á√ÉO =================== */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-print {
            background: #22c55e;
            color: white;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-reload {
            background: #3b82f6;
            color: white;
        }

        /* =================== LOADING =================== */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .loading-spinner {
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =================== DASHBOARD SECTION =================== */
        .dashboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            page-break-inside: avoid;
        }

        .dashboard-section.executivo {
            border-left: 4px solid #8b5cf6;
        }

        .dashboard-section.hospitalar {
            border-left: 4px solid #60a5fa;
        }

        .dashboard-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-header-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
        }

        .dashboard-header-section .badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.executivo {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid #8b5cf6;
        }

        .badge.hospital {
            background: rgba(96, 165, 250, 0.2);
            color: #93c5fd;
            border: 1px solid #60a5fa;
        }

        /* =================== KPI GRID (3 COLUNAS) =================== */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kpis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* =================== KPI BOX =================== */
        .kpi-box {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .kpi-box:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Cores da borda superior */
        .box-ocupados { border-top: 3px solid #22c55e; }
        .box-previsao { border-top: 3px solid #f97316; }
        .box-disponiveis { border-top: 3px solid #3b82f6; }
        .box-tph { border-top: 3px solid #8b5cf6; }
        .box-pps { border-top: 3px solid #ec4899; }
        .box-spict { border-top: 3px solid #14b8a6; }
        .box-ocupacao-geral { border-top: 3px solid #22c55e; }

        /* T√≠tulo do Box */
        .kpi-title {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        /* =================== V5 GAUGE (MEIA ROSCA) =================== */
        .v5-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .v5-gauge {
            width: 120px;
            height: 70px;
        }

        .v5-number-inside {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-top: 8px;
        }

        .v5-badge-below {
            font-size: 14px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid;
        }

        .v5-badge-below.green {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: #22c55e;
        }

        .v5-badge-below.orange {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border-color: #f97316;
        }

        .v5-badge-below.blue {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        /* =================== CONTE√öDO DO BOX =================== */
        .kpi-content {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
            flex: 1;
        }

        /* Lista Lateral (3 itens) */
        .kpi-items-lateral {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-lateral {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .item-lateral .label {
            font-size: 14px;
            color: #9ca3af;
        }

        .item-lateral .valor {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        /* =================== DETALHES (5 CATEGORIAS MODALIDADE) =================== */
        .kpi-detalhes {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .detalhe-titulo {
            font-size: 11px;
            font-weight: 600;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        /* Lista Compacta (50% espa√ßamento) */
        .lista-simples-compacta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lista-item-compacto {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s ease;
        }

        .lista-item-compacto:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lista-item-compacto .label {
            font-size: 13px;
            color: #9ca3af;
        }

        .lista-item-compacto .valor {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
        }

        /* =================== VALORES DUPLOS (PPS / SPICT) =================== */
        .kpi-valores-duplos-divididos {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 20px;
        }

        .kpi-valor-metade {
            flex: 1;
            text-align: center;
        }

        .kpi-valor-metade .valor {
            font-size: 72px;
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-bottom: 8px;
        }

        .kpi-valor-metade .label {
            font-size: 13px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .divisor-vertical {
            width: 1px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* =================== TPH =================== */
        .kpi-tph-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .kpi-tph-numero {
            font-size: 80px;
            font-weight: 700;
            color: white;
            line-height: 1;
        }

        .kpi-tph-label {
            font-size: 16px;
            color: #9ca3af;
            margin-top: 8px;
        }

        /* =================== TABELAS =================== */
        .hospitais-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .hospitais-table thead {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hospitais-table th {
            text-align: left;
            padding: 8px;
            color: #60a5fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .hospitais-table td {
            padding: 8px;
            color: #e5e7eb;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .hospitais-table tbody tr:last-child td {
            border-bottom: none;
        }

        .hospitais-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .sem-dados {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-style: italic;
            font-size: 13px;
        }

        /* =================== GAUGE LARGO (EXECUTIVO) =================== */
        .gauge-largo-container {
            position: relative;
            width: 450px;
            height: 220px;
            margin: 0 auto;
        }

        .gauge-largo-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%);
            text-align: center;
            width: 100%;
        }

        .gauge-largo-percentage {
            font-size: 60px;
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-bottom: 8px;
        }

        .gauge-largo-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .gauge-largo-number {
            font-size: 48px;
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-bottom: 4px;
        }

        .gauge-largo-subtitle {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* =================== BOX OCUPA√á√ÉO GERAL (EXECUTIVO) =================== */
        .box-ocupacao-geral .kpi-content {
            flex-direction: column;
            align-items: center;
        }

        /* =================== PRINT =================== */
        @media print {
            body {
                background: white;
                color: black;
                padding: 0;
            }

            .action-buttons {
                display: none;
            }

            .dashboard-section {
                page-break-inside: avoid;
                border: 1px solid #ddd;
            }

            .kpi-box {
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- HEADER -->
        <div class="page-header">
            <div>
                <h1>üè• KPIs Archipelago</h1>
                <div class="timestamp" id="timestamp">Carregando...</div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-print" onclick="window.print()">
                    üñ®Ô∏è Imprimir
                </button>
                <button class="btn btn-whatsapp" onclick="copiarParaWhatsApp()">
                    üì± Copiar para WhatsApp
                </button>
                <button class="btn btn-reload" onclick="recarregarDados()">
                    üîÑ Atualizar
                </button>
            </div>
        </div>

        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Carregando dados da planilha...</p>
        </div>

        <!-- CONTENT -->
        <div id="content" style="display: none;">
            <!-- DASHBOARD EXECUTIVO -->
            <div id="kpi-executivo"></div>

            <!-- DASHBOARDS HOSPITALARES -->
            <div id="kpis-hospitalares"></div>
        </div>
    </div>

    <script>
        // =================== FUN√á√ïES AUXILIARES ===================
        
        function formatarData() {
            const agora = new Date();
            const opcoes = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return agora.toLocaleDateString('pt-BR', opcoes);
        }

        function calcularGaugeOffset(porcentagem) {
            const circunferencia = Math.PI * 55; // Meia rosca
            const progresso = (porcentagem / 100) * circunferencia;
            return circunferencia - progresso;
        }

        function calcularGaugeLargoOffset(porcentagem) {
            const circunferencia = Math.PI * 180; // Gauge largo
            const progresso = (porcentagem / 100) * circunferencia;
            return circunferencia - progresso;
        }

        // =================== RENDER GAUGE V5 (MEIA ROSCA) ===================
        
        function renderGaugeV5(porcentagem, cor, numero) {
            const offset = calcularGaugeOffset(porcentagem);
            const badgeClass = cor === '#22c55e' ? 'green' : (cor === '#f97316' ? 'orange' : 'blue');
            
            return `
                <div class="v5-gauge-container">
                    <div style="position: relative;">
                        <svg class="v5-gauge" viewBox="0 0 140 80">
                            <!-- Fundo cinza -->
                            <path d="M 15 70 A 55 55 0 0 1 125 70" 
                                  fill="none" 
                                  stroke="rgba(255,255,255,0.1)" 
                                  stroke-width="14" 
                                  stroke-linecap="round"/>
                            <!-- Progresso -->
                            <path d="M 15 70 A 55 55 0 0 1 125 70" 
                                  fill="none" 
                                  stroke="${cor}" 
                                  stroke-width="14" 
                                  stroke-linecap="round"
                                  stroke-dasharray="172.8"
                                  stroke-dashoffset="${offset}"/>
                        </svg>
                        <div class="v5-number-inside">${numero.toString().padStart(2, '0')}</div>
                    </div>
                    <div class="v5-badge-below ${badgeClass}">${porcentagem.toFixed(0)}%</div>
                </div>
            `;
        }

        // =================== RENDER GAUGE LARGO (EXECUTIVO) ===================
        
        function renderGaugeLargo(porcentagem, numeroTotal) {
            const offset = calcularGaugeLargoOffset(porcentagem);
            
            return `
                <div style="display: flex; justify-content: center; margin: 60px 0 50px 0; padding-top: 20px;">
                    <div class="gauge-largo-container">
                        <!-- SVG Gauge Largo -->
                        <svg viewBox="0 0 450 220" style="width: 100%; height: 100%;">
                            <!-- Fundo cinza -->
                            <path d="M 40 180 A 180 180 0 0 1 410 180" 
                                  fill="none" 
                                  stroke="rgba(255,255,255,0.1)" 
                                  stroke-width="25" 
                                  stroke-linecap="round"/>
                            <!-- Progresso verde -->
                            <path d="M 40 180 A 180 180 0 0 1 410 180" 
                                  fill="none" 
                                  stroke="#22c55e" 
                                  stroke-width="25" 
                                  stroke-linecap="round"
                                  stroke-dasharray="565.5"
                                  stroke-dashoffset="${offset}"/>
                        </svg>
                        
                        <!-- Informa√ß√µes dentro do gauge -->
                        <div class="gauge-largo-info">
                            <div class="gauge-largo-percentage">${porcentagem.toFixed(0)}%</div>
                            <div class="gauge-largo-label">LEITOS OCUPADOS</div>
                            <div class="gauge-largo-number">${numeroTotal}</div>
                            <div class="gauge-largo-subtitle">
                                Total da Rede Externa<br/>(5 Hospitais)
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== RENDER MODALIDADE CONTRATUAL ===================
        
        function renderModalidadeContratual(modalidade) {
            return `
                <div class="lista-simples-compacta">
                    <div class="lista-item-compacto">
                        <span class="label">Flex√≠veis quanto ao plano</span>
                        <span class="valor">${modalidade.flexiveis || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclusivamente Apartamentos</span>
                        <span class="valor">${modalidade.exclusivo_apto || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf sem Restri√ß√£o</span>
                        <span class="valor">${modalidade.exclusivo_enf_sem_restricao || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf Feminina</span>
                        <span class="valor">${modalidade.exclusivo_enf_fem || 0}</span>
                    </div>
                    <div class="lista-item-compacto">
                        <span class="label">Exclus. Enf Masculina</span>
                        <span class="valor">${modalidade.exclusivo_enf_masc || 0}</span>
                    </div>
                </div>
            `;
        }

        // =================== ‚úÖ NOVA FUN√á√ÉO: CALCULAR MODALIDADES POR HOSPITAL ===================
        
        /**
         * Calcula modalidades baseado no tipo de leito e hospital
         * 
         * L√ìGICA:
         * - H2 (Cruz Azul): 
         *   - APTO ‚Üí Exclusivo Apartamento
         *   - ENFERMARIA ‚Üí Enf Fem/Masc (por g√™nero definido)
         * 
         * - H4 (Santa Clara):
         *   - APTO (max 9) ‚Üí Exclusivo Apartamento  
         *   - ENFERMARIA (max 4) ‚Üí Enf sem Restri√ß√£o
         * 
         * - H1, H3, H5 (H√≠bridos):
         *   - H√≠brido ‚Üí Flex√≠veis (pode ser apto OU enfermaria)
         */
        function calcularModalidadePorTipo(leitos, hospitalId) {
            const modalidade = {
                flexiveis: 0,
                exclusivo_apto: 0,
                exclusivo_enf_sem_restricao: 0,
                exclusivo_enf_fem: 0,
                exclusivo_enf_masc: 0
            };

            leitos.forEach(leito => {
                // Se tem categoriaEscolhida definida, usar ela
                if (leito.categoriaEscolhida && leito.categoriaEscolhida.trim() !== '') {
                    if (leito.categoriaEscolhida === 'Apartamento') {
                        modalidade.exclusivo_apto++;
                    } else if (leito.categoriaEscolhida === 'Enfermaria sem Restri√ß√£o') {
                        modalidade.exclusivo_enf_sem_restricao++;
                    } else if (leito.categoriaEscolhida === 'Enfermaria Feminina') {
                        modalidade.exclusivo_enf_fem++;
                    } else if (leito.categoriaEscolhida === 'Enfermaria Masculina') {
                        modalidade.exclusivo_enf_masc++;
                    } else {
                        modalidade.flexiveis++;
                    }
                    return;
                }

                // ‚úÖ L√ìGICA POR HOSPITAL
                const tipo = leito.tipo || '';
                
                // H2 - CRUZ AZUL
                if (hospitalId === 'H2') {
                    if (tipo === 'APTO' || tipo === 'Apartamento') {
                        modalidade.exclusivo_apto++;
                    } else if (tipo === 'ENFERMARIA' || tipo === 'Enfermaria Feminina' || tipo === 'Enfermaria Masculina') {
                        // Verificar g√™nero se dispon√≠vel
                        // Se tiver informa√ß√£o de g√™nero do paciente ou tipo espec√≠fico
                        if (tipo === 'Enfermaria Feminina' || leito.genero === 'F') {
                            modalidade.exclusivo_enf_fem++;
                        } else if (tipo === 'Enfermaria Masculina' || leito.genero === 'M') {
                            modalidade.exclusivo_enf_masc++;
                        } else {
                            // Se n√£o tem g√™nero definido, contar como sem restri√ß√£o
                            modalidade.exclusivo_enf_sem_restricao++;
                        }
                    } else {
                        modalidade.flexiveis++;
                    }
                }
                
                // H4 - SANTA CLARA  
                else if (hospitalId === 'H4') {
                    if (tipo === 'APTO' || tipo === 'Apartamento') {
                        modalidade.exclusivo_apto++;
                    } else if (tipo === 'ENFERMARIA' || tipo === 'Enfermaria Feminina' || tipo === 'Enfermaria Masculina') {
                        modalidade.exclusivo_enf_sem_restricao++;
                    } else {
                        modalidade.flexiveis++;
                    }
                }
                
                // H1, H3, H5 - H√çBRIDOS (todos flex√≠veis)
                else {
                    modalidade.flexiveis++;
                }
            });

            return modalidade;
        }

        // =================== PROCESSAR DADOS DA PLANILHA ===================
        
        function processarDadosHospital(hospitalId) {
            const hospitalObj = window.hospitalData[hospitalId] || {};
            
            // Debug: verificar estrutura dos dados
            console.log(`Processando ${hospitalId}:`, hospitalObj);
            
            // Garantir que leitos √© um array
            let leitos = hospitalObj.leitos || hospitalObj || [];
            if (!Array.isArray(leitos)) {
                console.warn(`${hospitalId}: leitos n√£o √© array, convertendo...`);
                leitos = [];
            }
            
            console.log(`${hospitalId}: ${leitos.length} leitos encontrados`);
            
            // Calcular ocupados
            const ocupados = leitos.filter(l => l.status === 'ocupado');
            
            // Calcular ocupados por tipo (considerando diferentes nomenclaturas)
            const ocupadosApto = ocupados.filter(l => 
                l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'H√≠brido'
            ).length;
            const ocupadosEnfFem = ocupados.filter(l => 
                l.tipo === 'Enfermaria Feminina'
            ).length;
            const ocupadosEnfMasc = ocupados.filter(l => 
                l.tipo === 'Enfermaria Masculina'
            ).length;
            
            // Calcular previs√£o de alta
            const previsaoAlta = leitos.filter(l => l.prevAlta && l.prevAlta.trim() !== '');
            const previsaoApto = previsaoAlta.filter(l => 
                l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'H√≠brido'
            ).length;
            const previsaoEnfFem = previsaoAlta.filter(l => 
                l.tipo === 'Enfermaria Feminina'
            ).length;
            const previsaoEnfMasc = previsaoAlta.filter(l => 
                l.tipo === 'Enfermaria Masculina'
            ).length;
            
            // Calcular dispon√≠veis
            const vagos = leitos.filter(l => l.status === 'vago');
            const vagosApto = vagos.filter(l => 
                l.tipo === 'Apartamento' || l.tipo === 'APTO' || l.tipo === 'H√≠brido'
            ).length;
            const vagosEnfFem = vagos.filter(l => 
                l.tipo === 'Enfermaria Feminina'
            ).length;
            const vagosEnfMasc = vagos.filter(l => 
                l.tipo === 'Enfermaria Masculina'
            ).length;
            
            // TPH m√©dio
            const tphValues = ocupados
                .map(l => {
                    if (!l.admAt) return 0;
                    const admData = new Date(l.admAt);
                    const hoje = new Date();
                    const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                    return dias > 0 ? dias : 0;
                })
                .filter(v => v > 0);
            const tphMedio = tphValues.length > 0 
                ? (tphValues.reduce((a, b) => a + b, 0) / tphValues.length).toFixed(1)
                : 0;
            
            const leitosMais5Diarias = ocupados.filter(l => {
                if (!l.admAt) return false;
                const admData = new Date(l.admAt);
                const hoje = new Date();
                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                return dias > 5;
            }).map(l => {
                const admData = new Date(l.admAt);
                const hoje = new Date();
                const dias = Math.floor((hoje - admData) / (1000 * 60 * 60 * 24));
                return { ...l, dias };
            });
            
            // PPS
            const ppsValues = ocupados
                .map(l => parseInt(l.pps) || 0)
                .filter(v => v > 0);
            const ppsMedio = ppsValues.length > 0
                ? Math.round(ppsValues.reduce((a, b) => a + b, 0) / ppsValues.length)
                : 0;
            const ppsMenor40 = ocupados.filter(l => parseInt(l.pps) < 40);
            
            // SPICT
            const spictElegiveis = ocupados.filter(l => 
                l.spict && l.spict.toLowerCase() === 'elegivel'
            );
            const diretivasPendentes = ocupados.filter(l => 
                l.spict && l.spict.toLowerCase() === 'elegivel' && (!l.diretivas || l.diretivas.trim() === '' || l.diretivas === 'N√£o')
            );
            
            // Calcular taxa de ocupa√ß√£o
            const totalLeitos = leitos.length;
            const taxaOcupacao = totalLeitos > 0 ? (ocupados.length / totalLeitos * 100) : 0;
            
            // ‚úÖ USAR NOVA FUN√á√ÉO DE C√ÅLCULO DE MODALIDADES
            const modalidadeOcupados = calcularModalidadePorTipo(ocupados, hospitalId);
            const modalidadePrevisao = calcularModalidadePorTipo(previsaoAlta, hospitalId);
            const modalidadeDisponiveis = calcularModalidadePorTipo(vagos, hospitalId);
            
            return {
                nome: hospitalId === 'H1' ? 'ADVENTISTA' :
                      hospitalId === 'H2' ? 'CRUZ AZUL' :
                      hospitalId === 'H3' ? 'NEOMATER' :
                      hospitalId === 'H4' ? 'SANTA CLARA' :
                      'STA MARCELINA',
                totalLeitos,
                taxaOcupacao,
                ocupados: {
                    total: ocupados.length,
                    apartamento: ocupadosApto,
                    enf_feminina: ocupadosEnfFem,
                    enf_masculina: ocupadosEnfMasc,
                    modalidade: modalidadeOcupados
                },
                previsao: {
                    total: previsaoAlta.length,
                    apartamento: previsaoApto,
                    enf_feminina: previsaoEnfFem,
                    enf_masculina: previsaoEnfMasc,
                    modalidade: modalidadePrevisao
                },
                disponiveis: {
                    total: vagos.length,
                    apartamento: vagosApto,
                    enf_feminina: vagosEnfFem,
                    enf_masculina: vagosEnfMasc,
                    modalidade: modalidadeDisponiveis
                },
                tph: {
                    medio: tphMedio,
                    lista: leitosMais5Diarias
                },
                pps: {
                    medio: ppsMedio,
                    menor40: ppsMenor40
                },
                spict: {
                    elegiveis: spictElegiveis.length,
                    diretivas: diretivasPendentes.length,
                    listaDiretivas: diretivasPendentes
                }
            };
        }

        // =================== RENDER DASHBOARD EXECUTIVO ===================
        
        function renderKPIExecutivo() {
            const hospitais = ['H1', 'H2', 'H3', 'H4', 'H5'].map(processarDadosHospital);
            
            // Consolidar dados
            const totalLeitos = hospitais.reduce((sum, h) => sum + h.totalLeitos, 0);
            const totalOcupados = hospitais.reduce((sum, h) => sum + h.ocupados.total, 0);
            const totalPrevisao = hospitais.reduce((sum, h) => sum + h.previsao.total, 0);
            const totalDisponiveis = hospitais.reduce((sum, h) => sum + h.disponiveis.total, 0);
            const taxaOcupacao = (totalOcupados / totalLeitos * 100);
            
            // Consolidar por tipo
            const previsaoApto = hospitais.reduce((sum, h) => sum + h.previsao.apartamento, 0);
            const previsaoEnfFem = hospitais.reduce((sum, h) => sum + h.previsao.enf_feminina, 0);
            const previsaoEnfMasc = hospitais.reduce((sum, h) => sum + h.previsao.enf_masculina, 0);
            
            const disponiveisApto = hospitais.reduce((sum, h) => sum + h.disponiveis.apartamento, 0);
            const disponiveisEnfFem = hospitais.reduce((sum, h) => sum + h.disponiveis.enf_feminina, 0);
            const disponiveisEnfMasc = hospitais.reduce((sum, h) => sum + h.disponiveis.enf_masculina, 0);
            
            // Consolidar modalidades
            const modalidadePrevisao = {
                flexiveis: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.flexiveis, 0),
                exclusivo_apto: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_apto, 0),
                exclusivo_enf_sem_restricao: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_sem_restricao, 0),
                exclusivo_enf_fem: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_fem, 0),
                exclusivo_enf_masc: hospitais.reduce((sum, h) => sum + h.previsao.modalidade.exclusivo_enf_masc, 0)
            };
            
            const modalidadeDisponiveis = {
                flexiveis: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.flexiveis, 0),
                exclusivo_apto: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_apto, 0),
                exclusivo_enf_sem_restricao: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_sem_restricao, 0),
                exclusivo_enf_fem: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_fem, 0),
                exclusivo_enf_masc: hospitais.reduce((sum, h) => sum + h.disponiveis.modalidade.exclusivo_enf_masc, 0)
            };
            
            // TPH m√©dio
            const tphTodos = hospitais.map(h => parseFloat(h.tph.medio)).filter(v => v > 0);
            const tphMedioGeral = tphTodos.length > 0 
                ? (tphTodos.reduce((a, b) => a + b, 0) / tphTodos.length).toFixed(1)
                : 0;
            
            // PPS m√©dio
            const ppsTodos = hospitais.map(h => h.pps.medio).filter(v => v > 0);
            const ppsMedioGeral = ppsTodos.length > 0
                ? Math.round(ppsTodos.reduce((a, b) => a + b, 0) / ppsTodos.length)
                : 0;
            const totalPPSMenor40 = hospitais.reduce((sum, h) => sum + h.pps.menor40.length, 0);
            
            // SPICT
            const totalSpict = hospitais.reduce((sum, h) => sum + h.spict.elegiveis, 0);
            const totalDiretivas = hospitais.reduce((sum, h) => sum + h.spict.diretivas, 0);
            const listaDiretivasConsolidada = hospitais.flatMap(h => 
                h.spict.listaDiretivas.map(l => ({ ...l, hospital: h.nome }))
            );
            
            return `
                <div class="dashboard-section executivo">
                    <div class="dashboard-header-section">
                        <h2>üìä Dashboard Executivo</h2>
                        <span class="badge executivo">Rede Externa</span>
                    </div>
                    
                    <div class="kpis-grid">
                        <!-- BOX 1: Ocupa√ß√£o Geral -->
                        <div class="kpi-box box-ocupacao-geral">
                            <div class="kpi-title">Ocupa√ß√£o Geral - Rede Externa</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeLargo(taxaOcupacao, totalOcupados)}
                            </div>
                            
                            <div class="kpi-detalhes">
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Leitos Fixos</th>
                                            <th>Leitos Ocupados</th>
                                            <th>Taxa Ocupa√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td><strong>${h.nome}</strong></td>
                                                <td>${h.totalLeitos}</td>
                                                <td>${h.ocupados.total}</td>
                                                <td>${h.taxaOcupacao.toFixed(1)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 2: Previs√£o de Alta -->
                        <div class="kpi-box box-previsao">
                            <div class="kpi-title">Leitos em Previs√£o de Alta</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((totalPrevisao / totalLeitos * 100), '#f97316', totalPrevisao)}
                                
                                <div class="kpi-items-lateral">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${previsaoApto}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${previsaoEnfFem}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${previsaoEnfMasc}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Leitos Divididos Conforme Modalidade Contratual com o Credenciado</div>
                                ${renderModalidadeContratual(modalidadePrevisao)}
                            </div>
                        </div>

                        <!-- BOX 3: Dispon√≠veis -->
                        <div class="kpi-box box-disponiveis">
                            <div class="kpi-title">Leitos Dispon√≠veis</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((totalDisponiveis / totalLeitos * 100), '#3b82f6', totalDisponiveis)}
                                
                                <div class="kpi-items-lateral">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-style: italic;">
                                        Capacidade por tipo de leito (n√£o simult√¢neo)
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">at√© ${disponiveisApto}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">at√© ${disponiveisEnfFem}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">at√© ${disponiveisEnfMasc}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Leitos Divididos Conforme Modalidade Contratual com o Credenciado</div>
                                ${renderModalidadeContratual(modalidadeDisponiveis)}
                            </div>
                        </div>

                        <!-- BOX 4: TPH -->
                        <div class="kpi-box box-tph">
                            <div class="kpi-title">TPH M√©dio</div>
                            
                            <div class="kpi-tph-container">
                                <div class="kpi-tph-numero">${tphMedioGeral}</div>
                                <div class="kpi-tph-label">dias</div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">TPH (dias)</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>TPH (dias)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td>${h.nome}</td>
                                                <td>${h.tph.medio}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 5: PPS -->
                        <div class="kpi-box box-pps">
                            <div class="kpi-title">PPS</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${ppsMedioGeral}</div>
                                    <div class="label">PPS M√©dio</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalPPSMenor40.toString().padStart(2, '0')}</div>
                                    <div class="label">PPS < 40%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">PPS < 40% por Hospital</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>PPS < 40%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td>${h.nome}</td>
                                                <td>${h.pps.menor40.length}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- BOX 6: SPICT -->
                        <div class="kpi-box box-spict">
                            <div class="kpi-title">SPICT-BR | Diretivas</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalSpict.toString().padStart(2, '0')}</div>
                                    <div class="label">SPICT-BR</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${totalDiretivas.toString().padStart(2, '0')}</div>
                                    <div class="label">Diretivas</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Diretivas Pendentes por Hospital</div>
                                <table class="hospitais-table">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>Diretivas Pendentes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hospitais.map(h => `
                                            <tr>
                                                <td>${h.nome}</td>
                                                <td>${h.spict.diretivas}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== RENDER DASHBOARD HOSPITALAR ===================
        
        function renderKPIHospitalar(hospitalId) {
            const dados = processarDadosHospital(hospitalId);
            
            return `
                <div class="dashboard-section hospitalar">
                    <div class="dashboard-header-section">
                        <h2>üè• ${dados.nome}</h2>
                        <span class="badge hospital">${hospitalId}</span>
                    </div>
                    
                    <div class="kpis-grid">
                        <!-- BOX 1: Leitos Ocupados -->
                        <div class="kpi-box box-ocupados">
                            <div class="kpi-title">Leitos Ocupados</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5(dados.taxaOcupacao, '#22c55e', dados.ocupados.total)}
                                
                                <div class="kpi-items-lateral">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${dados.ocupados.apartamento}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${dados.ocupados.enf_feminina}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${dados.ocupados.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.ocupados.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 2: Previs√£o de Alta -->
                        <div class="kpi-box box-previsao">
                            <div class="kpi-title">Leitos em Previs√£o de Alta</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((dados.previsao.total / dados.totalLeitos * 100), '#f97316', dados.previsao.total)}
                                
                                <div class="kpi-items-lateral">
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">${dados.previsao.apartamento}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">${dados.previsao.enf_feminina}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">${dados.previsao.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.previsao.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 3: Dispon√≠veis -->
                        <div class="kpi-box box-disponiveis">
                            <div class="kpi-title">Leitos Dispon√≠veis</div>
                            
                            <div class="kpi-content">
                                ${renderGaugeV5((dados.disponiveis.total / dados.totalLeitos * 100), '#3b82f6', dados.disponiveis.total)}
                                
                                <div class="kpi-items-lateral">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-style: italic;">
                                        Capacidade por tipo de leito (n√£o simult√¢neo)
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Apartamento</span>
                                        <span class="valor">at√© ${dados.disponiveis.apartamento}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Feminina</span>
                                        <span class="valor">at√© ${dados.disponiveis.enf_feminina}</span>
                                    </div>
                                    <div class="item-lateral">
                                        <span class="label">Enfermaria Masculina</span>
                                        <span class="valor">at√© ${dados.disponiveis.enf_masculina}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Modalidade Contratual</div>
                                ${renderModalidadeContratual(dados.disponiveis.modalidade)}
                            </div>
                        </div>

                        <!-- BOX 4: TPH -->
                        <div class="kpi-box box-tph">
                            <div class="kpi-title">TPH M√©dio</div>
                            
                            <div class="kpi-tph-container">
                                <div class="kpi-tph-numero">${dados.tph.medio}</div>
                                <div class="kpi-tph-label">dias</div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">N¬∫ Di√°rias > 5</div>
                                ${dados.tph.lista.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matr√≠cula</th>
                                                <th>Dias</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.tph.lista.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                    <td>${l.dias}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhum leito com mais de 5 di√°rias</div>'}
                            </div>
                        </div>

                        <!-- BOX 5: PPS -->
                        <div class="kpi-box box-pps">
                            <div class="kpi-title">PPS</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.pps.medio}</div>
                                    <div class="label">PPS M√©dio</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.pps.menor40.length.toString().padStart(2, '0')}</div>
                                    <div class="label">PPS < 40%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">PPS < 40%</div>
                                ${dados.pps.menor40.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matr√≠cula</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.pps.menor40.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhum leito com PPS < 40%</div>'}
                            </div>
                        </div>

                        <!-- BOX 6: SPICT -->
                        <div class="kpi-box box-spict">
                            <div class="kpi-title">SPICT-BR | Diretivas</div>
                            
                            <div class="kpi-valores-duplos-divididos">
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.spict.elegiveis.toString().padStart(2, '0')}</div>
                                    <div class="label">SPICT-BR</div>
                                </div>
                                <div class="divisor-vertical"></div>
                                <div class="kpi-valor-metade">
                                    <div class="valor">${dados.spict.diretivas.toString().padStart(2, '0')}</div>
                                    <div class="label">Diretivas</div>
                                </div>
                            </div>
                            
                            <div class="kpi-detalhes">
                                <div class="detalhe-titulo">Diretivas Pendentes</div>
                                ${dados.spict.listaDiretivas.length > 0 ? `
                                    <table class="hospitais-table">
                                        <thead>
                                            <tr>
                                                <th>Leito</th>
                                                <th>Matr√≠cula</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dados.spict.listaDiretivas.map(l => `
                                                <tr>
                                                    <td>${l.leito}</td>
                                                    <td>${l.matricula || '---'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<div class="sem-dados">Nenhuma diretiva pendente</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =================== FUN√á√ïES PRINCIPAIS ===================
        
        async function carregarDados() {
            try {
                console.log('Carregando dados...');
                
                // Carregar dados da API
                if (typeof window.loadHospitalData === 'function') {
                    await window.loadHospitalData();
                } else {
                    throw new Error('Fun√ß√£o loadHospitalData n√£o encontrada');
                }
                
                // Atualizar timestamp
                document.getElementById('timestamp').textContent = 'Atualizado em: ' + formatarData();
                
                // Renderizar conte√∫do
                document.getElementById('kpi-executivo').innerHTML = renderKPIExecutivo();
                
                let htmlHospitalares = '';
                ['H1', 'H2', 'H3', 'H4', 'H5'].forEach(hospitalId => {
                    htmlHospitalares += renderKPIHospitalar(hospitalId);
                });
                document.getElementById('kpis-hospitalares').innerHTML = htmlHospitalares;
                
                // Mostrar conte√∫do
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                console.log('‚úÖ Dados carregados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #ef4444;">‚ùå Erro ao carregar dados</p>
                    <p style="color: #9ca3af; font-size: 14px; margin-top: 10px;">${error.message}</p>
                    <button class="btn btn-reload" onclick="carregarDados()" style="margin-top: 20px;">
                        Tentar Novamente
                    </button>
                `;
            }
        }

        function recarregarDados() {
            document.getElementById('content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `
                <div class="loading-spinner"></div>
                <p>Recarregando dados da planilha...</p>
            `;
            
            // Limpar cache
            window.apiCache = {};
            window.hospitalData = {};
            
            carregarDados();
        }

        function copiarParaWhatsApp() {
            const hospitais = ['H1', 'H2', 'H3', 'H4', 'H5'].map(processarDadosHospital);
            
            // Dados executivos
            const totalLeitos = hospitais.reduce((sum, h) => sum + h.totalLeitos, 0);
            const totalOcupados = hospitais.reduce((sum, h) => sum + h.ocupados.total, 0);
            const taxaOcupacao = ((totalOcupados / totalLeitos) * 100).toFixed(1);
            
            let texto = `üè• *KPIs ARCHIPELAGO*\n`;
            texto += `üìÖ ${formatarData()}\n\n`;
            
            texto += `*üìä REDE EXTERNA (5 HOSPITAIS)*\n`;
            texto += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            texto += `Taxa de Ocupa√ß√£o: *${taxaOcupacao}%*\n`;
            texto += `Leitos Ocupados: *${totalOcupados}/${totalLeitos}*\n\n`;
            
            hospitais.forEach((h, index) => {
                texto += `*${index + 1}. ${h.nome}*\n`;
                texto += `‚Ä¢ Taxa: ${h.taxaOcupacao.toFixed(1)}%\n`;
                texto += `‚Ä¢ Ocupados: ${h.ocupados.total}/${h.totalLeitos}\n`;
                texto += `‚Ä¢ Previs√£o Alta: ${h.previsao.total}\n`;
                texto += `‚Ä¢ Dispon√≠veis: ${h.disponiveis.total}\n`;
                texto += `‚Ä¢ TPH: ${h.tph.medio} dias\n`;
                texto += `‚Ä¢ PPS M√©dio: ${h.pps.medio}\n`;
                texto += `‚Ä¢ SPICT: ${h.spict.elegiveis} | Diretivas: ${h.spict.diretivas}\n`;
                texto += `\n_Modalidades Dispon√≠veis:_\n`;
                texto += `  Flex√≠veis: ${h.disponiveis.modalidade.flexiveis}\n`;
                texto += `  Exclus. Apto: ${h.disponiveis.modalidade.exclusivo_apto}\n`;
                texto += `  Exclus. Enf s/ Restr: ${h.disponiveis.modalidade.exclusivo_enf_sem_restricao}\n`;
                texto += `  Exclus. Enf Fem: ${h.disponiveis.modalidade.exclusivo_enf_fem}\n`;
                texto += `  Exclus. Enf Masc: ${h.disponiveis.modalidade.exclusivo_enf_masc}\n`;
                if (index < hospitais.length - 1) texto += `\n`;
            });
            
            // Copiar para clipboard
            navigator.clipboard.writeText(texto).then(() => {
                alert('‚úÖ Texto copiado para a √°rea de transfer√™ncia!\n\nCole no WhatsApp e envie.');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Tente novamente.');
            });
        }

        // =================== INICIALIZA√á√ÉO ===================
        
        window.addEventListener('load', () => {
            // Aguardar um pouco para garantir que api.js carregou
            setTimeout(carregarDados, 500);
        });
    </script>
</body>
</html>
